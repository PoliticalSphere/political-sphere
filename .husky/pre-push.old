#!/bin/sh
# Enhanced pre-push hook with improved workspace integrity checks
# Owner: Platform Engineering
# Last updated: 2025-10-31

# Enable strict error handling
set -euo pipefail

echo "üîç Running enhanced pre-push workspace integrity check..."
echo ""

# In CI or fast mode, skip interactive checks to avoid blocking automation
if [ "${CI:-false}" = "true" ] || [ "${FAST_AI:-0}" = "1" ] || [ "${FAST_AI:-false}" = "true" ]; then
  echo "‚ö° FAST/CI mode detected ‚Äì skipping interactive integrity prompts"
  exit 0
fi

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
  echo "‚ùå Not in a git repository"
  exit 1
fi

# Function to count files
count_files() {
  find . -name "$1" \
    -not -path "*/node_modules/*" \
    -not -path "*/.nx/cache/*" \
    -not -path "*/dist/*" \
    2>/dev/null | wc -l | tr -d ' '
}

# Check critical files exist
echo "üìã Checking critical files..."
critical_files=("package.json" "nx.json" "tsconfig.base.json")
missing_count=0

for file in "${critical_files[@]}"; do
  if [ ! -f "$file" ]; then
    echo "   ‚ùå Missing: $file"
    missing_count=$((missing_count + 1))
  else
    echo "   ‚úÖ Found: $file"
  fi
done

if [ $missing_count -gt 0 ]; then
  echo ""
  echo "‚ùå ERROR: $missing_count critical file(s) missing!"
  echo ""
  echo "Your workspace is incomplete. This push is blocked."
  echo "Please verify all files are committed before pushing."
  exit 1
fi

# Check source code presence
echo ""
echo "üìä Counting source files..."
ts_count=$(count_files "*.ts")
js_count=$(count_files "*.js")

echo "   TypeScript files: $ts_count"
echo "   JavaScript files: $js_count"

# Warn if counts are suspiciously low
if [ "$ts_count" -lt 3 ] && [ "$js_count" -lt 15 ]; then
  echo ""
  echo "‚ö†Ô∏è  WARNING: Very few source files detected!"
  echo "   This might indicate an incomplete commit."
  echo ""
  read -p "   Are you sure you want to continue? (yes/no): " -r confirm
  echo ""
  
  if [ "$confirm" != "yes" ]; then
    echo "‚ùå Push cancelled by user"
    exit 1
  fi
fi

# Check .github/workflows exists
if [ ! -d ".github/workflows" ]; then
  echo ""
  echo "‚ö†Ô∏è  WARNING: .github/workflows directory is missing!"
  echo "   CI/CD workflows will not run."
  echo ""
  read -p "   Continue anyway? (yes/no): " -r confirm
  echo ""
  
  if [ "$confirm" != "yes" ]; then
    echo "‚ùå Push cancelled by user"
    exit 1
  fi
fi

echo ""
echo "‚úÖ Pre-push workspace integrity check passed"
echo ""

exit 0
