# ===============================================================================
# AI-ASSISTABLE METADATA
# ===============================================================================
# @workflow-name: Security Scanning
# @workflow-purpose: Consolidated security scanning (SAST, secrets, dependency, supply-chain)
# @workflow-category: security
# @workflow-criticality: high
# @workflow-owner: security-team
# @workflow-triggers: [push:main, pull_request:main, schedule]
# @workflow-dependencies: [gitleaks, semgrep, trivy, dependency-review]
# @workflow-stages: [secrets-and-workflows, sast-scanning, dependency-scanning, supply-chain]
# ===============================================================================
# ===============================================================================
# CONSOLIDATED SECURITY SCANNING WORKFLOW
# ===============================================================================
# This workflow consolidates all security scanning activities:
# - Vulnerability scanning (npm audit, Snyk, Trivy)
# - SAST scanning (Semgrep, CodeQL)
# - Secret scanning (Gitleaks)
# - Workflow security validation (actionlint, shell injection detection)
# - Supply chain security (SBOM generation, dependency review)
# - License compliance
# ==============================================================================

name: Security Scanning

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 2 * * 1" # Weekly on Mondays at 2 AM UTC
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write
  checks: write
  id-token: write
  attestations: write

concurrency:
  group: security-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "22"

jobs:
  # ===========================================================================
  # Job 1: Secret Scanning & Workflow Security
  # ===========================================================================
  secrets-and-workflows:
    name: Secrets & Workflow Security
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Gitleaks - Secret Scanning
        uses: gitleaks/gitleaks-action@v2.3.6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate Workflow Security
        run: |
          echo "üîç Running workflow security validator..."
          bash scripts/validate-workflows.sh

      - name: Install actionlint
        run: |
          ACTIONLINT_VERSION="1.7.4"
          echo "Installing actionlint ${ACTIONLINT_VERSION}..."
          curl -fsSL "https://github.com/rhysd/actionlint/releases/download/v${ACTIONLINT_VERSION}/actionlint_${ACTIONLINT_VERSION}_linux_amd64.tar.gz" \
            -o actionlint.tar.gz
          tar xzf actionlint.tar.gz
          sudo mv actionlint /usr/local/bin/
          rm actionlint.tar.gz
          actionlint -version

      - name: Run actionlint
        run: |
          actionlint -color -verbose

      - name: Check for hardcoded secrets in workflows
        run: |
          echo "üîç Scanning workflows for potential hardcoded secrets..."

          if find .github/workflows .github/actions libs/ci -type f \( -name "*.yml" -o -name "*.yaml" \) -exec \
            grep -iE '(password|secret|token|api[_-]?key|access[_-]?key|private[_-]?key)(\s*[:=]\s*["\x27][^\x27"]+["\x27])' {} + 2>/dev/null | \
            grep -v 'secrets\.' | grep -v 'inputs\.' | grep -v 'env\.' | grep -v '#'; then
            echo "‚ùå Potential hardcoded secrets found!"
            exit 1
          else
            echo "‚úÖ No hardcoded secrets detected"
          fi

      - name: Validate Cryptographic Algorithms
        run: |
          echo "üîê Running cryptographic algorithm validator..."
          bash scripts/validate-crypto.sh

  # ===========================================================================
  # Job 2: SAST - Static Application Security Testing
  # ===========================================================================
  sast-scanning:
    name: SAST Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 15
    container:
      image: returntocorp/semgrep:1.67.0
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Validate required secrets
        shell: sh
        env:
          EVENT_NAME: ${{ github.event_name }}
          PR_HEAD_REPO: ${{ github.event.pull_request.head.repo.full_name }}
          CURRENT_REPO: ${{ github.repository }}
        run: |
          # Only require secrets for pushes to main or PRs from same repo (not forks)
          if [ "${EVENT_NAME}" = "push" ] || [ "${PR_HEAD_REPO}" = "${CURRENT_REPO}" ]; then
            if [ -z "${{ secrets.SEMGREP_APP_TOKEN }}" ]; then
              echo "::warning::SEMGREP_APP_TOKEN not set - scan will run in local mode only"
            fi
          else
            echo "::notice::Skipping Semgrep Cloud for fork PR (secrets not available)"
          fi

      - name: Run Semgrep Security Scan
        id: semgrep
        run: |
          echo "üîí Running Semgrep security scan..."
          semgrep ci --config auto --json --sarif --output semgrep-results.sarif > semgrep-results.json || true

          if [ -f semgrep-results.json ]; then
            findings=$(jq '.results | length' semgrep-results.json 2>/dev/null || echo "0")
            echo "findings=$findings" >> $GITHUB_OUTPUT
            echo "üìà Found $findings security findings"
            
            if [ "$findings" -gt 0 ]; then
              echo "‚ö†Ô∏è Semgrep found security issues - review required"
            fi
          fi
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: Upload SARIF Results
        if: always()
        uses: github/codeql-action/upload-sarif@e2b3eafc8d227b0241d48be5f425d47c2d750a13 # v3.26.10
        with:
          sarif_file: semgrep-results.sarif
          category: semgrep
        continue-on-error: true

      - name: Upload Semgrep Results
        if: always()
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4.3.6
        with:
          name: semgrep-scan-results
          path: |
            semgrep-results.json
            semgrep-results.sarif
          retention-days: 30

  # ===========================================================================
  # Job 3: CodeQL Analysis (for JavaScript/TypeScript)
  # ===========================================================================
  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'push' || github.event_name == 'schedule'
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false

      - name: Initialize CodeQL
        uses: github/codeql-action/init@e2b3eafc8d227b0241d48be5f425d47c2d750a13 # v3.26.10
        with:
          languages: javascript
          queries: security-extended

      - name: Autobuild
        uses: github/codeql-action/autobuild@e2b3eafc8d227b0241d48be5f425d47c2d750a13 # v3.26.10

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@e2b3eafc8d227b0241d48be5f425d47c2d750a13 # v3.26.10
        with:
          category: codeql

  # ===========================================================================
  # Job 4: Dependency & Vulnerability Scanning
  # ===========================================================================
  dependency-scanning:
    name: Dependency & Vulnerability Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: |
          echo "üîç Running npm audit..."
          npm audit --audit-level=moderate --json > npm-audit-results.json || true

          # Display summary
          if [ -f npm-audit-results.json ]; then
            echo "üìä Audit Summary:"
            jq '.metadata.vulnerabilities' npm-audit-results.json || true
          fi

      - name: Dependency Review (PR only)
        if: github.event_name == 'pull_request'
        uses: actions/dependency-review-action@5a2ce3f5b92ee19cbb1541a4984c76d921601d7c # v4.3.4
        with:
          fail-on-severity: moderate
          deny-licenses: GPL-2.0, GPL-3.0

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin

      - name: Run Trivy filesystem scan
        run: |
          echo "üîç Running Trivy scan..."
          trivy fs --exit-code 0 --severity CRITICAL,HIGH --format json --output trivy-results.json .

          # Display summary
          if [ -f trivy-results.json ]; then
            echo "üìä Trivy found:"
            jq '.Results[] | select(.Vulnerabilities) | .Vulnerabilities | length' trivy-results.json || echo "0 vulnerabilities"
          fi

      - name: Upload npm audit results
        if: always()
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4.3.6
        with:
          name: npm-audit-results
          path: npm-audit-results.json
          retention-days: 30

      - name: Upload Trivy results
        if: always()
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4.3.6
        with:
          name: trivy-scan-results
          path: trivy-results.json
          retention-days: 30

  # ===========================================================================
  # Job 5: Supply Chain Security & SBOM
  # ===========================================================================
  supply-chain:
    name: Supply Chain Security
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Generate SBOM (Software Bill of Materials)
        run: |
          echo "üì¶ Generating SBOM..."
          npx @cyclonedx/cyclonedx-npm --output-file sbom.json
          echo "‚úÖ SBOM generated"

      - name: Build artifacts (if applicable)
        run: |
          if npm run build --if-present; then
            echo "‚úÖ Build completed"
          else
            echo "‚ÑπÔ∏è No build script found or build skipped"
          fi

      - name: Attest build provenance (SLSA)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/attest-build-provenance@1c608d11d69870c2092266b3f9a6f3abbf17002c # v1.4.3
        with:
          subject-path: |
            dist/**
            libs/**/dist/**
        continue-on-error: true

      - name: Upload SBOM
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4.3.6
        with:
          name: sbom
          path: sbom.json
          retention-days: 90

  # ===========================================================================
  # Job 6: Security Summary & Reporting
  # ===========================================================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs:
      [secrets-and-workflows, sast-scanning, dependency-scanning, supply-chain]
    if: always()
    steps:
      - name: Generate Security Summary
        run: |
          echo "## üîí Security Scanning Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scans Performed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Secret scanning (Gitleaks)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Workflow security validation" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ SAST scanning (Semgrep)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ CodeQL analysis" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Dependency scanning (npm audit, Trivy)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Supply chain security (SBOM, SLSA provenance)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security Guidelines" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Never commit secrets or credentials" >> $GITHUB_STEP_SUMMARY
          echo "- Keep dependencies updated regularly" >> $GITHUB_STEP_SUMMARY
          echo "- Address critical/high vulnerabilities promptly" >> $GITHUB_STEP_SUMMARY
          echo "- Use \`env:\` blocks for GitHub context in workflows" >> $GITHUB_STEP_SUMMARY
          echo "- Pin action versions to commit SHAs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìö [Security Documentation](https://docs.github.com/en/code-security)" >> $GITHUB_STEP_SUMMARY

      - name: Check job statuses
        run: |
          SECRETS_STATUS="${{ needs.secrets-and-workflows.result }}"
          SAST_STATUS="${{ needs.sast-scanning.result }}"
          DEPS_STATUS="${{ needs.dependency-scanning.result }}"
          SUPPLY_STATUS="${{ needs.supply-chain.result }}"

          echo "Job Results:"
          echo "  Secrets & Workflows: $SECRETS_STATUS"
          echo "  SAST Scanning: $SAST_STATUS"
          echo "  Dependency Scanning: $DEPS_STATUS"
          echo "  Supply Chain: $SUPPLY_STATUS"

          # Fail if any critical job failed
          if [[ "$SECRETS_STATUS" == "failure" ]] || [[ "$SAST_STATUS" == "failure" ]] || [[ "$DEPS_STATUS" == "failure" ]]; then
            echo "‚ùå One or more security scans failed!"
            exit 1
          fi

          echo "‚úÖ All security scans completed"
