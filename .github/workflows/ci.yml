name: CI
on:
  pull_request:
  push:
    branches: [main]
jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: 'npm' }
      - run: npm ci
      - name: Nx Cache
        uses: actions/cache@v4
        with:
          path: .nx/cache
          key: nx-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-${{ github.sha }}
          restore-keys: |
            nx-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-
      - run: npm run lint
      - run: npm run typecheck
      - run: npm test --workspaces --if-present
      - name: Retry failed tests once
        run: npm test --workspaces --if-present -- --runInBand=false || npm test --workspaces --if-present -- --runInBand=false
      - name: Docs Lint
        run: npm run docs:lint
      - name: Gitleaks
        uses: gitleaks/gitleaks-action@v2
        with: { args: "detect --source . --verbose" }
      - name: Conftest
        uses: open-policy-agent/conftest-action@v1
        with:
          policy: policies/
          input: platform/
  containers:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with: { dockerfile: '**/Dockerfile' }
      - name: Build images (dry)
        run: echo "build step placeholder to keep free minutes low"
  iac:
    runs-on: ubuntu-latest
    defaults: { run: { working-directory: infrastructure } }
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
      - name: tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
      - name: Checkov
        uses: bridgecrewio/checkov-action@master
        with: { directory: . }
