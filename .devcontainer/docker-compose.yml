# =============================================================================
# Docker Compose for Political Sphere Development Environment
#
# Follows OWASP Docker Security Best Practices and 12-factor app methodology
# Note: No version field needed for Docker Compose v2+
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Main development container (Node.js application)
  # ---------------------------------------------------------------------------
  dev:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
      # Build arguments for customization
      args:
        NODE_VERSION: '20'
        BUILDKIT_INLINE_CACHE: 1

    volumes:
      # Workspace mount with cached consistency for performance
      - ../..:/workspaces:cached
      # Named volume for node_modules (faster on macOS/Windows)
      - node_modules:/workspaces/${localWorkspaceFolderBasename}/node_modules
      # NPM cache volume for faster installs
      - npm_cache:/home/node/.npm
      # Docker socket for Docker-in-Docker (managed by devcontainer feature)
      - /var/run/docker.sock:/var/run/docker.sock

    working_dir: /workspaces/${localWorkspaceFolderBasename}
    command: sleep infinity

    # Environment variables (12-factor app - store config in environment)
    environment:
      - NODE_ENV=development
      - LOG_LEVEL=debug
      - DOCKER_HOST=unix:///var/run/docker.sock
      # Database connection (constructed from service discovery)
      - DATABASE_URL=postgresql://dev:dev_password@postgres:5432/political_sphere_dev
      - REDIS_URL=redis://redis:6379
      # JWT secrets (for development only - use secrets in production)
      - JWT_SECRET=dev_jwt_secret_min_32_chars_required_for_development_only
      - JWT_REFRESH_SECRET=dev_refresh_secret_min_32_chars_required_for_development

    # Security options (OWASP Rule #4: Limit capabilities & #5: Prevent privilege escalation)
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined # Required for debugging
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID
      - NET_BIND_SERVICE

    # User configuration (OWASP Rule #3: Set a non-root user)
    user: node

    # Resource limits (OWASP Rule #10: Limit resources)
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G

    # Network configuration
    networks:
      - political-sphere-dev

    # Structured logging (OWASP Rule #11: Set filesystem and volumes to read-only)
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'
        labels: 'service,environment'
        env: 'NODE_ENV'
        tag: '{{.Name}}/{{.ID}}'

    # Service dependencies with health checks
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

    # Health check for the development container
    healthcheck:
      test: ['CMD-SHELL', 'node --version && npm --version']
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ---------------------------------------------------------------------------
  # PostgreSQL database for development
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:16-alpine

    environment:
      POSTGRES_DB: political_sphere_dev
      POSTGRES_USER: dev
      # In production, use POSTGRES_PASSWORD_FILE with Docker secrets
      POSTGRES_PASSWORD: dev_password

    ports:
      - '5432:5432'

    volumes:
      # Persistent database storage
      - postgres_data:/var/lib/postgresql/data
      # Initialization scripts
      - ./init-scripts:/docker-entrypoint-initdb.d:ro

    networks:
      - political-sphere-dev

    # Security hardening (OWASP compliance)
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID

    # Read-only filesystem with tmpfs for runtime data (OWASP Rule #11)
    read_only: true
    tmpfs:
      - /tmp
      - /var/run/postgresql

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    # Health check
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U dev -d political_sphere_dev']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  # ---------------------------------------------------------------------------
  # Redis cache for development
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine

    ports:
      - '6379:6379'

    volumes:
      # Persistent cache storage
      - redis_data:/data
      # Redis configuration
      - ./redis.conf:/usr/local/etc/redis/redis.conf:ro

    # Use custom config if present, otherwise use defaults
    command: >
      sh -c "if [ -f /usr/local/etc/redis/redis.conf ]; then
               redis-server /usr/local/etc/redis/redis.conf;
             else
               redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru;
             fi"

    networks:
      - political-sphere-dev

    # Security hardening
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - SETGID
      - SETUID

    # Read-only filesystem
    read_only: true
    tmpfs:
      - /tmp

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M

    # Health check
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s

    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

# =============================================================================
# Named volumes for persistent data
# =============================================================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  node_modules:
    driver: local
  npm_cache:
    driver: local

# =============================================================================
# Secrets (for production - development uses environment variables)
# =============================================================================
# Secrets section removed for development - using environment variables
# In production, uncomment and use proper secrets management

# =============================================================================
# Networks
# =============================================================================
networks:
  political-sphere-dev:
    driver: bridge
    # Enable IPv6 if needed (disabled by default for compatibility)
    # enable_ipv6: false
    # Custom network configuration
    driver_opts:
      com.docker.network.bridge.name: br-political-sphere
    ipam:
      config:
        - subnet: 172.28.0.0/16
