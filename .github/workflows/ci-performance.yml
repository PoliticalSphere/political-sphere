# ==============================================================================
# AI-ASSISTABLE METADATA
# ==============================================================================
# @workflow-name: CI Performance Optimization
# @workflow-purpose: Advanced caching and performance monitoring for <5min builds
# @workflow-category: ci-performance
# @workflow-criticality: high
# @workflow-owner: platform-engineering
# @workflow-slo: <5min P50 build time, <8min P95, >90% cache hit rate
# @workflow-maturity: 4
# @workflow-dependencies: [buildx, turbo-cache, nx-cloud]
# @workflow-triggers: [push:main, pull_request:main]
# @workflow-stages: [intelligent-cache, parallel-build, performance-tracking]
# @workflow-architecture-ref: docs/architecture/cicd-flow.md
# @workflow-target-improvement: 30% faster (7.2min â†’ 5min)
# ==============================================================================

name: CI Performance Optimization

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ci-perf-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "22"
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

jobs:
  performance-preflight:
    name: Performance-Optimized Preflight
    runs-on: ubuntu-latest
    timeout-minutes: 3 # Aggressive timeout
    outputs:
      cache-hit: ${{ steps.cache.outputs.cache-hit }}
      affected-projects: ${{ steps.affected.outputs.projects }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for NX affected

      - name: Setup Node with multi-layer caching
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Restore global dependency cache
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            ~/.cache
            node_modules
            */*/node_modules
            .nx/cache
          key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}-v2
          restore-keys: |
            ${{ runner.os }}-node-${{ env.NODE_VERSION }}-
            ${{ runner.os }}-node-

      - name: Install dependencies (if cache miss)
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          echo "âš¡ Cache miss - installing dependencies..."
          npm ci --prefer-offline --no-audit
        env:
          CYPRESS_INSTALL_BINARY: 0 # Skip Cypress binary in CI

      - name: Detect affected projects (NX)
        id: affected
        run: |
          echo "ðŸ” Detecting affected projects..."
          
          # Use NX to detect what changed
          AFFECTED=$(npx nx show projects --affected --base=origin/main --head=HEAD | tr '\n' ',' | sed 's/,$//')
          
          echo "projects=${AFFECTED}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Affected projects: ${AFFECTED}"

      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            dist
            .next
            .turbo
            apps/*/dist
            libs/*/dist
          key: ${{ runner.os }}-build-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-build-

  fast-lint-and-typecheck:
    name: Fast Lint & Type Check
    runs-on: ubuntu-latest
    needs: performance-preflight
    timeout-minutes: 5 # Reduced from 10min
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1 # Shallow clone for speed

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Restore dependency cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
            */*/node_modules
          key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}-v2

      - name: Install (cached)
        run: npm ci --prefer-offline --no-audit

      - name: Parallel Lint + Type Check
        run: |
          echo "âš¡ Running lint and type-check in parallel..."
          
          # Run both in parallel using background jobs
          npm run lint &
          LINT_PID=$!
          
          npm run type-check &
          TYPECHECK_PID=$!
          
          # Wait for both to complete
          wait $LINT_PID
          LINT_EXIT=$?
          
          wait $TYPECHECK_PID
          TYPECHECK_EXIT=$?
          
          # Check exit codes
          if [ $LINT_EXIT -ne 0 ] || [ $TYPECHECK_EXIT -ne 0 ]; then
            echo "âŒ Quality checks failed"
            exit 1
          fi
          
          echo "âœ… Quality checks passed"

  turbocharged-tests:
    name: Turbocharged Tests (Shard ${{ matrix.shard }})
    runs-on: ubuntu-latest
    needs: performance-preflight
    timeout-minutes: 10 # Reduced from 15min
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4] # Increased sharding for parallelism
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Restore dependency cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
            */*/node_modules
          key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}-v2

      - name: Install (cached)
        run: npm ci --prefer-offline --no-audit

      - name: Restore test cache
        uses: actions/cache@v4
        with:
          path: |
            .vitest-cache
            node_modules/.cache/vitest
          key: ${{ runner.os }}-test-cache-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-test-cache-

      - name: Run tests with Turbo (shard ${{ matrix.shard }}/4)
        run: |
          echo "âš¡ Running tests with maximum parallelism..."
          
          # Use all available CPU cores
          CORES=$(nproc)
          
          npm run test -- \
            --shard=${{ matrix.shard }}/4 \
            --maxWorkers=${CORES} \
            --coverage \
            --coverageDirectory=coverage-shard-${{ matrix.shard }} \
            --cache-dir=.vitest-cache

      - name: Upload coverage shard
        uses: actions/upload-artifact@v4
        with:
          name: coverage-shard-${{ matrix.shard }}
          path: coverage-shard-${{ matrix.shard }}/
          retention-days: 1

  performance-tracking:
    name: Track CI Performance Metrics
    runs-on: ubuntu-latest
    needs: [fast-lint-and-typecheck, turbocharged-tests]
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Calculate build duration
        id: duration
        run: |
          # Get workflow start time
          START_TIME="${{ github.event.workflow_run.created_at || github.event.created_at }}"
          CURRENT_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # Calculate duration (approximate)
          START_EPOCH=$(date -d "${START_TIME}" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "${START_TIME}" +%s 2>/dev/null || echo 0)
          CURRENT_EPOCH=$(date +%s)
          DURATION=$((CURRENT_EPOCH - START_EPOCH))
          
          echo "duration=${DURATION}" >> $GITHUB_OUTPUT
          echo "ðŸ“Š Build duration: ${DURATION} seconds"

      - name: Check SLO compliance
        run: |
          DURATION=${{ steps.duration.outputs.duration }}
          
          # SLO targets from .github/SLO.md
          TARGET_P50=300  # 5 minutes
          TARGET_P95=480  # 8 minutes
          
          echo "## âš¡ CI Performance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Duration**: ${DURATION}s ($(echo "scale=1; ${DURATION}/60" | bc)min)" >> $GITHUB_STEP_SUMMARY
          echo "**Target P50**: ${TARGET_P50}s (5min)" >> $GITHUB_STEP_SUMMARY
          echo "**Target P95**: ${TARGET_P95}s (8min)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ ${DURATION} -le ${TARGET_P50} ]; then
            echo "âœ… **Status**: Meeting P50 target!" >> $GITHUB_STEP_SUMMARY
          elif [ ${DURATION} -le ${TARGET_P95} ]; then
            echo "ðŸŸ¡ **Status**: Within P95 target (room for improvement)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status**: Exceeding P95 target (optimization needed)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Optimizations Applied" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Multi-layer dependency caching" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… 4-way test sharding (up from 3)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Parallel lint + type-check" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Shallow git clones" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… NX affected detection" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Aggressive timeouts" >> $GITHUB_STEP_SUMMARY

      - name: Log performance metrics
        run: |
          mkdir -p .github/metrics/performance
          
          cat > ".github/metrics/performance/$(date +%Y-%m-%d-%H%M%S).json" <<EOF
          {
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "workflow_name": "${{ github.workflow }}",
            "run_id": "${{ github.run_id }}",
            "duration_seconds": ${{ steps.duration.outputs.duration }},
            "cache_hit": "${{ needs.performance-preflight.outputs.cache-hit }}",
            "shards": 4,
            "optimizations": [
              "multi-layer-caching",
              "4-way-sharding",
              "parallel-quality-checks",
              "shallow-clone",
              "nx-affected"
            ]
          }
          EOF
          
          echo "âœ… Performance metrics logged"

  cache-warming:
    name: Warm Cache for Future Builds
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [fast-lint-and-typecheck, turbocharged-tests]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Pre-build and cache
        run: |
          echo "ðŸ”¥ Warming cache for future builds..."
          
          npm ci --prefer-offline
          npm run build --if-present || echo "No build script"
          
          echo "âœ… Cache warmed for next build"

      - name: Save warmed cache
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.npm
            node_modules
            */*/node_modules
            dist
            .nx/cache
          key: ${{ runner.os }}-warm-cache-${{ github.sha }}
