# ==============================================================================
# AI-ASSISTABLE METADATA
# ==============================================================================
# @workflow-name: Continuous Integration
# @workflow-purpose: Primary CI pipeline for code quality, testing, and security
# @workflow-category: ci
# @workflow-criticality: high
# @workflow-owner: platform-engineering
# @workflow-slo: 95% success rate, <10min P95 duration
# @workflow-maturity: 4 (sovereign-grade in progress)
# @workflow-dependencies: [nx-cloud, gitleaks, semgrep, vitest]
# @workflow-triggers: [push:main, pull_request:main, manual]
# @workflow-stages: [preflight, lint-typecheck, test, security, integration, deploy-preview]
# @workflow-architecture-ref: docs/architecture/cicd-flow.md
# @workflow-adr-ref: docs/adr/001-github-actions-as-ci-platform.md
# ==============================================================================

name: Continuous Integration
on:
  push:
    branches: [main, docs/observability-improvements]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Cancel in-progress runs for the same PR/branch
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

# Restrict permissions to minimum required
permissions:
  contents: read
  security-events: write
  pull-requests: write

env:
  NODE_VERSION: "22"
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
  CI: true
jobs:
  # Quick validation - fail fast
  pre-flight:
    name: Pre-flight Checks
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - name: Validate required secrets
        env:
          EVENT_NAME: ${{ github.event_name }}
          PR_HEAD_REPO: ${{ github.event.pull_request.head.repo.full_name }}
          CURRENT_REPO: ${{ github.repository }}
          ACTOR: ${{ github.actor }}
        run: |
          # Ensure required secrets are present to avoid runtime failures
          # Dependabot PRs don't have access to secrets for security reasons
          if [ "${ACTOR}" == "dependabot[bot]" ]; then
            echo "::notice::Skipping secret validation for Dependabot PR (secrets not available)"
            echo "NX_CLOUD_DISABLED=true" >> "$GITHUB_ENV"
            exit 0
          fi

          # Only require secrets for pushes to main or PRs from same repo (not forks)
          if [ "${EVENT_NAME}" == "push" ] || [ "${PR_HEAD_REPO}" == "${CURRENT_REPO}" ]; then
            if [ -z "${NX_CLOUD_ACCESS_TOKEN}" ]; then
              echo "::error::Missing required secret: NX_CLOUD_ACCESS_TOKEN"
              exit 1
            fi
          else
            echo "::notice::Skipping secret validation for fork PR"
            echo "NX_CLOUD_DISABLED=true" >> "$GITHUB_ENV"
          fi

      - name: Validate workflow files
        continue-on-error: true
        run: |
          echo "Validating GitHub Actions workflows..."
          find .github/workflows -name "*.yml" -o -name "*.yaml" | while read -r file; do
            echo "Checking ${file}"
            # Basic YAML validation
            python3 -c "import yaml; yaml.safe_load(open('${file}'))" || {
              echo "::warning::Failed to validate ${file}"
              exit 1
            }
          done

      - name: Check for secrets in code
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Governance pre-checks (migrated from governance/guard-check.yml)
      - name: Setup Node.js for governance checks
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies (if needed)
        run: |
          if [ -f package.json ]; then 
            echo "Installing dependencies..."
            npm ci --omit=dev || {
              echo "::warning::npm ci --omit=dev failed, trying full install"
              npm ci
            }
          fi

      - name: Run CI tools check
        continue-on-error: true
        run: |
          node --version
          if [ -f scripts/ci/check-tools.mjs ]; then
            node scripts/ci/check-tools.mjs
          else
            echo "::warning::scripts/ci/check-tools.mjs not found, skipping"
          fi

      - name: Validate CODEOWNERS teams
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EVENT_NAME: ${{ github.event_name }}
          PR_HEAD_REPO: ${{ github.event.pull_request.head.repo.full_name }}
          CURRENT_REPO: ${{ github.repository }}
        run: |
          echo "Validating CODEOWNERS teams exist..."

          # Extract team names from CODEOWNERS (format: @org/team-name)
          TEAMS=$(grep -oE '@[a-zA-Z0-9_-]+/[a-zA-Z0-9_-]+' .github/CODEOWNERS | sort -u || true)

          if [ -z "$TEAMS" ]; then
            echo "::notice::No teams found in CODEOWNERS file"
            exit 0
          fi

          echo "Found teams in CODEOWNERS:"
          echo "$TEAMS"

          # For fork PRs, skip validation as secrets aren't available
          if [ "$EVENT_NAME" = "pull_request" ] && \
             [ "$PR_HEAD_REPO" != "$CURRENT_REPO" ]; then
            echo "::notice::Skipping CODEOWNERS validation for fork PR"
            exit 0
          fi

          echo "::warning::CODEOWNERS team validation requires GitHub API access - implement full validation when needed"

      - name: Run guard-change-budget (Safe mode)
        continue-on-error: true
        if: ${{ github.event_name == 'pull_request' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BASE_REF: ${{ github.event.pull_request.base.ref }}
        run: |
          if [ -f tools/scripts/ai/guard-change-budget.mjs ]; then
            node --version
            node tools/scripts/ai/guard-change-budget.mjs --mode=Safe --base="origin/${PR_BASE_REF}"
          else
            echo "::warning::guard-change-budget.mjs not found, skipping budget check"
          fi

  lint-and-typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    needs: [pre-flight]
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-node-deps
        with:
          node-version: ${{ env.NODE_VERSION }}

      - uses: ./.github/actions/quality-checks

      - name: Check for TODO/FIXME comments
        run: |
          echo "Checking for unresolved TODOs and FIXMEs..."
          grep -r "TODO\|FIXME" apps/ libs/ --exclude-dir=node_modules --exclude-dir=dist || echo "No TODOs found"

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [pre-flight]
    timeout-minutes: 15
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
    strategy:
      fail-fast: false # Prevent race conditions from failing entire matrix
      matrix:
        shard: [1, 2, 3]
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-node-deps
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run tests (shard ${{ matrix.shard }}/3)
        env:
          SHARD_INDEX: ${{ matrix.shard }}
        run: npm run test -- --shard="${SHARD_INDEX}"/3 --maxWorkers=2 --coverage --coverageDirectory="coverage-shard-${SHARD_INDEX}"
      - name: Upload shard coverage
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: coverage-shard-${{ matrix.shard }}
          path: coverage-shard-${{ matrix.shard }}/
          retention-days: 7

      - name: Upload test results
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        if: always()
        with:
          name: test-results-shard-${{ matrix.shard }}
          path: coverage/
          retention-days: 30

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7 # v5.5.1
        if: always()
        with:
          files: ./coverage/lcov.info
          flags: unittests-shard-${{ matrix.shard }}
          name: codecov-shard-${{ matrix.shard }}
          fail_ci_if_error: false
  coverage-aggregation:
    name: Aggregate Test Coverage
    runs-on: ubuntu-latest
    needs: [test]
    timeout-minutes: 5
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Wait for all shards to complete
        run: |
          echo "Ensuring all test shards have completed..."
          sleep 5  # Brief pause to ensure artifacts are fully uploaded

      - name: Download all coverage shards
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          pattern: coverage-shard-*
          path: coverage-shards/

      - name: Verify all shards downloaded
        run: |
          echo "Verifying coverage shards..."
          EXPECTED_SHARDS=3
          DOWNLOADED_SHARDS=$(find coverage-shards -name "lcov.info" | wc -l)

          if [ "$DOWNLOADED_SHARDS" -ne "$EXPECTED_SHARDS" ]; then
            echo "❌ Expected $EXPECTED_SHARDS shards but found $DOWNLOADED_SHARDS"
            echo "Available artifacts:"
            ls -la coverage-shards/
            exit 1
          fi
          echo "✅ All $DOWNLOADED_SHARDS shards downloaded successfully"

      - name: Combine coverage reports
        run: |
          npm install -g istanbul-combine
          find coverage-shards -name "lcov.info" -print0 | xargs -0 istanbul-combine --output combined-coverage.json --report json

      - name: Check combined coverage threshold
        run: |
          if [ -f combined-coverage.json ]; then
            COVERAGE=$(node -p "JSON.parse(require('fs').readFileSync('combined-coverage.json')).total.lines.pct || 0")
            echo "Combined Coverage: ${COVERAGE}%"
            
            # Use node for arithmetic comparison (compatible across all runners)
            THRESHOLD_MET=$(node -e "console.log(parseFloat('${COVERAGE}') >= 80 ? 'true' : 'false')")
            
            if [ "$THRESHOLD_MET" = "false" ]; then
              echo "❌ Combined coverage ${COVERAGE}% is below 80% threshold"
              exit 1
            fi
            echo "✅ Combined coverage ${COVERAGE}% meets 80% threshold"
          else
            echo "⚠️ No combined coverage report found"
            exit 1
          fi

      - name: Upload combined coverage
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: combined-coverage
          path: combined-coverage.json
          retention-days: 90

  build:
    name: Build Applications
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, coverage-aggregation]
    timeout-minutes: 20
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-node-deps
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build all applications
        run: npm run build
      - name: Verify build outputs
        run: |
          echo "Checking build artifacts..."
          if [ ! -d "dist" ]; then
            echo "❌ dist/ directory not found"
            exit 1
          fi

          # Count built artifacts
          artifact_count=$(find dist -type f | wc -l)
          echo "✅ Found ${artifact_count} build artifacts"

          if [ "${artifact_count}" -lt 5 ]; then
            echo "⚠️ Warning: Fewer artifacts than expected"
          fi

      - name: Generate build manifest
        run: |
          cat > dist/BUILD_MANIFEST.json <<EOF
          {
            "git_sha": "${{ github.sha }}",
            "git_ref": "${{ github.ref }}",
            "build_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "node_version": "${{ env.NODE_VERSION }}",
            "ci_run_id": "${{ github.run_id }}",
            "ci_run_number": "${{ github.run_number }}"
          }
          EOF
          echo "Build manifest:"
          cat dist/BUILD_MANIFEST.json

      - name: Upload build artifacts
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: build-artifacts
          path: dist/
          retention-days: 30

      - name: Upload build manifest
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: build-manifest
          path: dist/BUILD_MANIFEST.json
          retention-days: 90

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: [pre-flight]
    timeout-minutes: 15
    permissions:
      security-events: write
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v4.2.2

      - uses: ./.github/actions/setup-node-deps
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run npm audit
        run: |
          npm audit --audit-level=moderate || {
            echo "⚠️ npm audit found vulnerabilities"
            npm audit --audit-level=moderate --json > audit-results.json
            exit 1
          }

      - name: Dependency Review
        uses: actions/dependency-review-action@40c09b7dc99638e5ddb0bfd91c1673effc064d8a # v4.8.1
        if: github.event_name == 'pull_request'
        with:
          fail-on-severity: moderate
          deny-licenses: GPL-2.0, GPL-3.0, AGPL-3.0

      - name: Run Semgrep Security Scan
        run: |
          echo "Running Semgrep security scan..."
          semgrep ci --config auto --json > semgrep-results.json || {
            echo "❌ Semgrep scan found issues"
            cat semgrep-results.json
            exit 1
          }
          echo "✅ Semgrep scan passed"
      - name: Upload security scan results
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        if: always()
        with:
          name: security-scan-results
          path: |
            audit-results.json
            semgrep-results.json
          retention-days: 90

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [build]
    timeout-minutes: 20
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-node-deps
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run database migrations
        run: npm run migrate
      - name: Verify database schema
        env:
          PGPASSWORD: test
        run: |
          echo "Verifying database schema after migrations..."
          # Check if migrations table exists and has entries
          if ! MIGRATION_COUNT=$(psql -h localhost -U test -d testdb -t -c "SELECT COUNT(*) FROM _prisma_migrations;" 2>&1); then
            echo "❌ Database connection or query failed: $MIGRATION_COUNT"
            exit 1
          fi

          MIGRATION_COUNT=$(echo "$MIGRATION_COUNT" | tr -d '[:space:]')

          if [ "$MIGRATION_COUNT" -eq "0" ]; then
            echo "❌ No migrations found in database"
            exit 1
          fi
          echo "✅ Found $MIGRATION_COUNT migration(s) applied"

      - name: Run integration tests
        run: npm run test:integration
      - name: Upload integration test results
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        if: always()
        with:
          name: integration-test-results
          path: test-results/
          retention-days: 30

  e2e-test:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: [build]
    timeout-minutes: 30
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-node-deps
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Prepare e2e environment
        run: npm run e2e:prepare
        timeout-minutes: 5

      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to be healthy..."
          timeout 60 bash -c 'until curl -f http://localhost:3000/health 2>/dev/null; do sleep 2; done' || {
            echo "❌ Services failed to start"
            docker compose logs
            exit 1
          }
          echo "✅ Services are ready"

      - name: Run e2e tests
        run: npm run test:e2e -- --reporter=html,json
      - name: Upload e2e test results
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        if: always()
        with:
          name: e2e-test-results
          path: |
            playwright-report/
            test-results/
          retention-days: 30

      - name: Upload failure screenshots
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        if: failure()
        with:
          name: e2e-failure-screenshots
          path: test-results/**/*.png
          retention-days: 7

      - name: Teardown e2e environment
        if: always()
        run: npm run docker:down

  accessibility-test:
    name: Accessibility Tests (WCAG 2.2 AA+)
    runs-on: ubuntu-latest
    needs: [build]
    timeout-minutes: 20
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-node-deps
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Start services for a11y testing
        run: npm run docker:up

      - name: Wait for services to be ready
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:3000/health 2>/dev/null; do sleep 2; done'

      - name: Run accessibility tests
        run: npm run test:a11y
      - name: Check for accessibility violations
        run: |
          if [ -f artifacts/accessibility-report.json ]; then
            violations=$(jq '.violations | length' artifacts/accessibility-report.json)
            if [ "$violations" -gt 0 ]; then
              echo "❌ Found $violations accessibility violations"
              jq '.violations' artifacts/accessibility-report.json
              exit 1
            fi
            echo "✅ No accessibility violations found"
          fi

      - name: Upload accessibility report
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        if: always()
        with:
          name: accessibility-report
          path: artifacts/accessibility-report.json
          retention-days: 30

      - name: Comment PR with a11y results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('artifacts/accessibility-report.json')) {
              const report = JSON.parse(fs.readFileSync('artifacts/accessibility-report.json'));
              const violations = report.violations || [];
              const comment = violations.length === 0
                ? '✅ **Accessibility Check Passed** - No WCAG 2.2 AA+ violations found!'
                : `❌ **Accessibility Check Failed** - Found ${violations.length} violation(s):\n\n${violations.map(v => `- ${v.description}`).join('\n')}`;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      - name: Teardown services
        if: always()
        run: npm run docker:down

  performance-test:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    needs: [build]
    timeout-minutes: 15
    if: (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository)
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-node-deps
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run API performance tests
        run: npm run perf:api || echo "Performance tests not configured"
        continue-on-error: true

      - name: Compare with baseline
        run: |
          if [ -f scripts/perf/performance-baseline.json ] && [ -f artifacts/performance-results.json ]; then
            echo "Comparing performance with baseline..."
            # Add comparison logic here
            echo "✅ Performance comparison complete"
          else
            echo "⚠️ Baseline or results not found, skipping comparison"
          fi

      - name: Upload performance results
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        if: always()
        with:
          name: performance-results
          path: artifacts/performance-results.json
          retention-days: 30

  ci-performance-monitoring:
    name: CI Performance Monitoring
    runs-on: ubuntu-latest
    needs:
      [
        lint-and-typecheck,
        test,
        coverage-aggregation,
        build,
        security-scan,
        integration-test,
        e2e-test,
        accessibility-test,
      ]
    if: always()
    timeout-minutes: 5
    steps:
      - name: Collect job metrics
        env:
          RUN_ID: ${{ github.run_id }}
          RUN_NUMBER: ${{ github.run_number }}
          EVENT_NAME: ${{ github.event_name }}
          REF: ${{ github.ref }}
          SHA: ${{ github.sha }}
        run: |
          echo "Collecting CI performance metrics..."
          cat > ci-metrics.json <<EOF
          {
            "run_id": "${RUN_ID}",
            "run_number": "${RUN_NUMBER}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "trigger": "${EVENT_NAME}",
            "ref": "${REF}",
            "sha": "${SHA}",
            "jobs": {
              "lint-and-typecheck": {
                "result": "${{ needs.lint-and-typecheck.result }}",
                  "duration_seconds": 0
              },
              "test": {
                "result": "${{ needs.test.result }}",
                  "duration_seconds": 0
              },
              "coverage-aggregation": {
                "result": "${{ needs.coverage-aggregation.result }}",
                  "duration_seconds": 0
              },
              "build": {
                "result": "${{ needs.build.result }}",
                  "duration_seconds": 0
              },
              "security-scan": {
                "result": "${{ needs.security-scan.result }}",
                  "duration_seconds": 0
              },
              "integration-test": {
                "result": "${{ needs.integration-test.result }}",
                  "duration_seconds": 0
              },
              "e2e-test": {
                "result": "${{ needs.e2e-test.result }}",
                  "duration_seconds": 0
              },
              "accessibility-test": {
                "result": "${{ needs.accessibility-test.result }}",
                  "duration_seconds": 0
              }
            }
          }
          EOF

      - name: Upload CI metrics
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: ci-performance-metrics
          path: ci-metrics.json
          retention-days: 365

  # Final gate - all checks must pass
  all-checks-passed:
    name: All CI Checks Passed
    runs-on: ubuntu-latest
    needs:
      [
        lint-and-typecheck,
        test,
        build,
        security-scan,
        integration-test,
        e2e-test,
        accessibility-test,
        ci-performance-monitoring,
      ]
    timeout-minutes: 5
    if: always()
    steps:
      - name: Check if all jobs passed
        run: |
          # Debug: Print all job results
          echo "=== Job Results Debug ==="
          echo "lint-and-typecheck: ${{ needs.lint-and-typecheck.result }}"
          echo "security-scan: ${{ needs.security-scan.result }}"
          echo "test: ${{ needs.test.result }}"
          echo "build: ${{ needs.build.result }}"
          echo "integration-test: ${{ needs.integration-test.result }}"
          echo "e2e-test: ${{ needs.e2e-test.result }}"
          echo "accessibility-test: ${{ needs.accessibility-test.result }}"
          echo "ci-performance-monitoring: ${{ needs.ci-performance-monitoring.result }}"
          echo "======================="

          # For fork PRs, allow skipped jobs that require secrets
          IS_FORK_PR=false
          EVENT_NAME="${{ github.event_name }}"
          PR_HEAD_REPO="${{ github.event.pull_request.head.repo.full_name }}"
          CURRENT_REPO="${{ github.repository }}"
          if [[ "$EVENT_NAME" == "pull_request" ]] && [[ "$PR_HEAD_REPO" != "$CURRENT_REPO" ]]; then
            IS_FORK_PR=true
            echo "Detected fork PR - allowing skipped jobs for secret-dependent tasks"
          fi

          # Check required jobs (these should never be skipped)
          FAILED=false

          if [[ "${{ needs.lint-and-typecheck.result }}" != "success" ]]; then
            echo "❌ lint-and-typecheck failed or was skipped"
            FAILED=true
          fi

          if [[ "${{ needs.security-scan.result }}" != "success" ]]; then
            echo "❌ security-scan failed or was skipped"
            FAILED=true
          fi

          # For fork PRs, allow skipped for jobs requiring secrets
          if [[ "$IS_FORK_PR" == "true" ]]; then
            # Check if jobs are either success or skipped
            for job in test build integration-test e2e-test accessibility-test; do
              case $job in
                test) result="${{ needs.test.result }}" ;;
                build) result="${{ needs.build.result }}" ;;
                integration-test) result="${{ needs.integration-test.result }}" ;;
                e2e-test) result="${{ needs.e2e-test.result }}" ;;
                accessibility-test) result="${{ needs.accessibility-test.result }}" ;;
              esac
              
              if [[ "$result" != "success" && "$result" != "skipped" ]]; then
                echo "❌ $job failed (result: $result)"
                FAILED=true
              fi
            done
          else
            # For non-fork PRs and pushes, require all jobs to succeed
            if [[ "${{ needs.test.result }}" != "success" ]]; then
              echo "❌ test failed or was skipped (result: ${{ needs.test.result }})"
              FAILED=true
            fi
            
            if [[ "${{ needs.build.result }}" != "success" ]]; then
              echo "❌ build failed or was skipped (result: ${{ needs.build.result }})"
              FAILED=true
            fi
            
            if [[ "${{ needs.integration-test.result }}" != "success" ]]; then
              echo "❌ integration-test failed or was skipped (result: ${{ needs.integration-test.result }})"
              FAILED=true
            fi
            
            if [[ "${{ needs.e2e-test.result }}" != "success" ]]; then
              echo "❌ e2e-test failed or was skipped (result: ${{ needs.e2e-test.result }})"
              FAILED=true
            fi
            
            if [[ "${{ needs.accessibility-test.result }}" != "success" ]]; then
              echo "❌ accessibility-test failed or was skipped (result: ${{ needs.accessibility-test.result }})"
              FAILED=true
            fi
          fi

          # ci-performance-monitoring can be skipped
          PERF_MONITOR_RESULT="${{ needs.ci-performance-monitoring.result }}"
          if [[ "$PERF_MONITOR_RESULT" != "success" && "$PERF_MONITOR_RESULT" != "skipped" ]]; then
            echo "⚠️  ci-performance-monitoring failed (result: $PERF_MONITOR_RESULT)"
            # Not failing the build for monitoring issues
          fi

          if [[ "$FAILED" == "true" ]]; then
            echo "❌ One or more CI checks failed"
            exit 1
          fi

          echo "✅ All CI checks passed successfully!"

      - name: Post success comment to PR
        if: github.event_name == 'pull_request' && success()
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ **All CI checks passed!** This PR is ready for review.'
            });
