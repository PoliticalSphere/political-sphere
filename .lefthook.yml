# .lefthook.yml
# Pre-commit configuration for Political Sphere
# Uses lint-staged for standard linting/formatting + specialized checks
# Owner: Platform Engineering
# Last updated: 2025-11-01

# Performance and resource configuration
colors: true
output:
  - summary
  - execution
  - execution_out
  - execution_info
  - meta

pre-commit:
  parallel: true
  commands:
    # Standard linting and formatting (ESLint, Prettier, Biome)
    lint-staged:
      run: npx lint-staged

    # Spell checking with detailed output
    cspell:
      run: npx cspell {staged_files}
      files: git diff --name-only --cached -- '*.ts' '*.tsx' '*.js' '*.jsx' '*.md'
      interactive: true

    # Accessibility checks for UI changes
    a11y:
      run: bash scripts/ci/a11y-check.sh
      files: git diff --name-only --cached -- '*.tsx' '*.jsx'

    # Module boundary enforcement
    import-boundaries:
      run: node scripts/ci/check-import-boundaries.js
      files: git diff --name-only --cached -- '*.ts' '*.tsx' '*.js' '*.jsx'

    # Secret scanning (fast mode - gitleaks on staged changes only)
    secrets:
      run: |
        echo "üîç Scanning for secrets..."
        if command -v gitleaks >/dev/null 2>&1; then
          if gitleaks protect --staged --verbose --log-level info; then
            echo "‚úÖ No secrets detected"
          else
            echo "‚ùå Secrets detected! Review the output above."
            exit 1
          fi
        else
          echo "‚ö†Ô∏è  Warning: gitleaks not installed, skipping secret scan (install via: brew install gitleaks)"
        fi
      interactive: true

commit-msg:
  commands:
    # Enforce conventional commit messages
    commitlint:
      run: npx commitlint --edit {1}

pre-push:
  commands:
    # Fast workspace integrity check (critical files only)
    integrity:
      run: |
        echo "üîç Checking workspace integrity..."
        if [ ! -f "package.json" ] || [ ! -f "nx.json" ]; then
          echo "‚ùå Critical files missing!"
          exit 1
        fi
        echo "‚úÖ Workspace integrity OK"

    # Run affected tests before push (skip with SKIP_TESTS=1)
    test-affected:
      run: |
        if [ "${SKIP_TESTS:-0}" = "1" ]; then
          echo "‚ö†Ô∏è  Skipping tests (SKIP_TESTS=1)"
          exit 0
        fi
        echo "üß™ Running tests for affected projects..."
        echo "   (Use SKIP_TESTS=1 git push to skip)"
        if npx nx affected:test --base=origin/main --head=HEAD --verbose; then
          echo ""
          echo "‚úÖ All tests passed"
        else
          echo ""
          echo "‚ùå Tests failed! See output above for details."
          echo "Fix the failing tests before pushing, or use SKIP_TESTS=1 to bypass."
          exit 1
        fi
      interactive: true

    # Run linting on affected projects (skip with SKIP_LINT=1)
    lint-affected:
      run: |
        if [ "${SKIP_LINT:-0}" = "1" ]; then
          echo "‚ö†Ô∏è  Skipping lint (SKIP_LINT=1)"
          exit 0
        fi
        echo "üîç Linting affected projects..."
        echo "   (Use SKIP_LINT=1 git push to skip)"
        if npx nx affected:lint --base=origin/main --head=HEAD; then
          echo ""
          echo "‚úÖ Linting passed"
        else
          echo ""
          echo "‚ùå Linting failed! See output above for details."
          echo "Fix the linting errors before pushing, or use SKIP_LINT=1 to bypass."
          exit 1
        fi
      interactive: true
