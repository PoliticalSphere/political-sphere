# .lefthook.yml
# Pre-commit configuration for Political Sphere
# Uses lint-staged for standard linting/formatting + specialized checks
# Owner: Platform Engineering
# Last updated: 2025-11-01

# Performance and resource configuration
colors: true
output:
  - summary
  - execution
  - execution_out
  - execution_info
  - meta

pre-commit:
  parallel: true
  commands:
    # Welcome message with branding
    welcome:
      run: |
        set -u
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘         ğŸ›ï¸  POLITICAL SPHERE ğŸ›ï¸                     â•‘"
        echo "â•‘                                                    â•‘"
        echo "â•‘    Democratic Governance â€¢ Political Simulation    â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "âœ¨ Thank you for contributing to democratic technology!"
        echo ""
        # Quick context
        STAGED=$(git diff --name-only --cached | wc -l | tr -d ' ')
        echo "ğŸ“¦ Staged files: ${STAGED}"
        if [ "$STAGED" -eq 0 ]; then
          echo "â„¹ï¸  No staged files detected. Some checks may be skipped."
        fi
        echo ""

    # Context overview for staged files (counts by type)
    staged-overview:
      run: |
        set -u
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ§­ Context Overview"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        TS=$(git diff --name-only --cached -- '*.ts' '*.tsx' | wc -l | tr -d ' ')
        JS=$(git diff --name-only --cached -- '*.js' '*.jsx' | wc -l | tr -d ' ')
        MD=$(git diff --name-only --cached -- '*.md' | wc -l | tr -d ' ')
        OTHER=$(git diff --name-only --cached \
          | grep -Ev '\.(ts|tsx|js|jsx|md)$' || true)
        if [ -n "$OTHER" ]; then OTHER_COUNT=$(printf "%s\n" "$OTHER" | wc -l | tr -d ' '); else OTHER_COUNT=0; fi
        printf "   â€¢ TypeScript:  %s\n" "$TS"
        printf "   â€¢ JavaScript:  %s\n" "$JS"
        printf "   â€¢ Markdown:    %s\n" "$MD"
        printf "   â€¢ Other:       %s\n" "$OTHER_COUNT"
        echo ""

    # Standard linting and formatting (ESLint, Prettier, Biome)
    lint-staged:
      run: npx lint-staged

    # Spell checking with detailed output
    cspell:
      run: |
        set -u
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ”¤ Spell Checking (cspell)"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        FILES=$(git diff --name-only --cached -- '*.ts' '*.tsx' '*.js' '*.jsx' '*.md')
        if [ -z "$FILES" ]; then
          echo "â„¹ï¸  No relevant files staged; skipping cspell."
          exit 0
        fi
        if npx cspell $FILES; then
          echo "âœ… Spelling OK"
        else
          echo "âŒ Spelling issues detected. See errors above."
          echo "ğŸ’¡ Tip: add valid domain terms to cspell.json#words"
          exit 1
        fi
      files: git diff --name-only --cached -- '*.ts' '*.tsx' '*.js' '*.jsx' '*.md'
      interactive: true

    # Accessibility checks for UI changes
    a11y:
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "â™¿ Accessibility Check"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        if [ "${SKIP_A11Y:-0}" = "1" ]; then
          echo "âš ï¸  Skipped (SKIP_A11Y=1)"
          exit 0
        fi
        bash scripts/ci/a11y-check.sh
      files: git diff --name-only --cached -- '*.tsx' '*.jsx'

    # Module boundary enforcement
    import-boundaries:
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ§± Import Boundaries"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        node scripts/ci/check-import-boundaries.js
      files: git diff --name-only --cached -- '*.ts' '*.tsx' '*.js' '*.jsx'

    # Secret scanning (fast mode - gitleaks on staged changes only)
    secrets:
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ›¡ï¸  Secret Scanning"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        if command -v gitleaks >/dev/null 2>&1; then
          if gitleaks protect --staged --verbose --log-level info 2>&1; then
            echo ""
            echo "âœ… No secrets detected"
          else
            echo ""
            echo "âŒ FAILED: Secrets detected! Review the output above."
            exit 1
          fi
        else
          echo "âš ï¸  Warning: gitleaks not installed"
          echo "   Install: brew install gitleaks"
          echo "   Docs: docs/SECURITY.md#secret-scanning"
        fi
        echo ""
      interactive: true

commit-msg:
  commands:
    # Enforce conventional commit messages
    commitlint:
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“ Commit Message Lint"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        SUBJECT=$(head -n1 "$1" || true)
        echo "Subject: $SUBJECT"
        npx commitlint --edit "$1"

pre-push:
  commands:
    # Fast workspace integrity check (critical files only)
    integrity:
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ” Workspace Integrity"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        if [ ! -f "package.json" ] || [ ! -f "nx.json" ]; then
          echo "âŒ FAILED: Critical files missing!"
          exit 1
        fi
        echo "âœ… All critical files present"
        echo ""

    # Run affected tests before push (skip with SKIP_TESTS=1)
    test-affected:
      run: |
        SECONDS=0
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ§ª Running Tests"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        if [ "${SKIP_TESTS:-0}" = "1" ]; then
          echo "âš ï¸  Skipped (SKIP_TESTS=1)"
          echo ""
          exit 0
        fi
        echo "ğŸ’¡ Tip: Use SKIP_TESTS=1 git push to skip"
        echo ""
        BASE_REF=${BASE_REF:-origin/main}
        if ! git rev-parse --verify --quiet "$BASE_REF" >/dev/null; then
          if git rev-parse --verify --quiet main >/dev/null; then BASE_REF=main; fi
        fi
        if npx nx affected:test --base="$BASE_REF" --head=HEAD --verbose; then
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… All tests passed (time: ${SECONDS}s)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
        else
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ FAILED: Tests failed (time: ${SECONDS}s)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Review the output above for details."
          echo "Fix failing tests or use: SKIP_TESTS=1 git push"
          echo ""
          exit 1
        fi
      interactive: true

    # Run linting on affected projects (skip with SKIP_LINT=1)
    lint-affected:
      run: |
        SECONDS=0
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ” Linting Code"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        if [ "${SKIP_LINT:-0}" = "1" ]; then
          echo "âš ï¸  Skipped (SKIP_LINT=1)"
          echo ""
          exit 0
        fi
        echo "ğŸ’¡ Tip: Use SKIP_LINT=1 git push to skip"
        echo ""
        BASE_REF=${BASE_REF:-origin/main}
        if ! git rev-parse --verify --quiet "$BASE_REF" >/dev/null; then
          if git rev-parse --verify --quiet main >/dev/null; then BASE_REF=main; fi
        fi
        if npx nx affected:lint --base="$BASE_REF" --head=HEAD; then
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Linting passed (time: ${SECONDS}s)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
        else
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ FAILED: Linting errors found (time: ${SECONDS}s)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Review the output above for details."
          echo "Fix linting errors or use: SKIP_LINT=1 git push"
          echo ""
          exit 1
        fi
      interactive: true

    # Check GitHub Actions status for main branch
    check-ci-status:
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š GitHub Actions Status (main branch)"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""

        # Check if gh CLI is installed
        if ! command -v gh >/dev/null 2>&1; then
          echo "âš ï¸  GitHub CLI not installed"
          echo "   Install: brew install gh"
          echo ""
          exit 0
        fi

        # Check if authenticated
        if ! gh auth status >/dev/null 2>&1; then
          echo "âš ï¸  Not authenticated with GitHub"
          echo "   Run: gh auth login"
          echo ""
          exit 0
        fi

        # Get workflow runs for main branch
        echo "Recent CI runs:"
        echo ""
        gh run list --branch main --limit 8 --json conclusion,name,status,createdAt,workflowName --jq '.[] | "\(.status)|\(.conclusion // "pending")|\(.workflowName)"' | while IFS='|' read status conclusion workflow; do
          # Truncate long workflow names
          if [ ${#workflow} -gt 40 ]; then
            workflow="${workflow:0:37}..."
          fi
          
          if [ "$status" = "completed" ]; then
            if [ "$conclusion" = "success" ]; then
              printf "   âœ…  %-45s [PASSED]\n" "$workflow"
            elif [ "$conclusion" = "failure" ]; then
              printf "   âŒ  %-45s [FAILED]\n" "$workflow"
            elif [ "$conclusion" = "cancelled" ]; then
              printf "   âš ï¸   %-45s [CANCELLED]\n" "$workflow"
            else
              printf "   â“  %-45s [%s]\n" "$workflow" "$conclusion"
            fi
          else
            printf "   ğŸ”„  %-45s [IN PROGRESS]\n" "$workflow"
          fi
        done

        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ’¡ Commands:"
        echo "   â€¢ View all runs:  gh run list --branch main"
        echo "   â€¢ View logs:      gh run view <run-id> --log"
        echo "   â€¢ Watch latest:   gh run watch"
        echo ""
      interactive: true

    # Thank contributors
    thank-you:
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘                                                    â•‘"
        echo "â•‘           ğŸ™ Thank You, Contributor! ğŸ™           â•‘"
        echo "â•‘                                                    â•‘"
        echo "â•‘   Your work strengthens democratic technology     â•‘"
        echo "â•‘   and helps build transparent governance tools    â•‘"
        echo "â•‘                                                    â•‘"
        echo "â•‘   Every contribution matters. Keep building! ğŸš€   â•‘"
        echo "â•‘                                                    â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
