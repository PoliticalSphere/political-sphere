name: Security & Quality Audit

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]
  schedule:
    # Run weekly security scans on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      auto_fix:
        description: 'Enable auto-fix for fixable issues'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write # For auto-fix commits
  security-events: write # For SARIF upload
  pull-requests: write # For PR comments

env:
  NODE_VERSION: '22'
  FORCE_COLOR: '1'

jobs:
  infrastructure-audit:
    name: Infrastructure Audit (GitHub/DevContainer/OpenAPI)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0 # Full history for better analysis

      - name: Install audit tools
        run: |
          # actionlint for GitHub workflow validation
          wget -qO- https://github.com/rhysd/actionlint/releases/latest/download/actionlint_1.7.8_linux_amd64.tar.gz | tar -xz actionlint
          sudo mv actionlint /usr/local/bin/

          # yamllint for YAML validation
          pip install yamllint==1.35.1

          # gitleaks for secret scanning
          wget -qO- https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks_8.28.0_linux_x64.tar.gz | tar -xz gitleaks
          sudo mv gitleaks /usr/local/bin/

          # hadolint for Dockerfile linting
          wget -qO /usr/local/bin/hadolint https://github.com/hadolint/hadolint/releases/download/v2.14.0/hadolint-Linux-x86_64
          chmod +x /usr/local/bin/hadolint

          # trivy for container vulnerability scanning
          wget -qO- https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.67.2_Linux-64bit.tar.gz | tar -xz trivy
          sudo mv trivy /usr/local/bin/

      - name: Run GitHub workflow audit
        run: bash scripts/ci/github-audit.sh
        continue-on-error: true

      - name: Run DevContainer audit
        run: bash scripts/ci/devcontainer-audit.sh
        continue-on-error: true

      - name: Run OpenAPI audit
        run: bash scripts/ci/openapi-audit-fast.sh
        continue-on-error: true

      - name: Upload infrastructure audit results
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: infrastructure-audit-results
          path: |
            reports/github-audit/
            reports/devcontainer-audit/
            reports/openapi-audit/
          retention-days: 30

  app-audit:
    name: Application Audit (${{ matrix.app }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        app:
          - api
          - web
          - worker
          - game-server
          - shell
          - feature-auth-remote
          - feature-dashboard-remote

    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install OWASP Dependency-Check
        run: |
          wget https://github.com/dependency-check/DependencyCheck/releases/download/v12.1.8/dependency-check-12.1.8-release.zip
          unzip dependency-check-12.1.8-release.zip
          sudo mv dependency-check /usr/local/
          sudo ln -s /usr/local/dependency-check/bin/dependency-check.sh /usr/local/bin/dependency-check

      - name: Run app audit
        env:
          APP_NAME: ${{ matrix.app }}
          AUTO_FIX: ${{ github.event.inputs.auto_fix || 'false' }}
          GENERATE_SARIF: 'true'
          SKIP_NPM_AUDIT: 'false'
          SKIP_TSC: 'false'
          SKIP_ESLINT: 'false'
        run: bash scripts/ci/app-audit-$APP_NAME.sh
        continue-on-error: true

      - name: Commit auto-fixes
        if: github.event.inputs.auto_fix == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'fix: auto-fix issues in ${{ matrix.app }} [skip ci]'
          file_pattern: 'apps/${{ matrix.app }}/**'

      - name: Upload SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: reports/app-audit/${{ matrix.app }}/audit-results.sarif
          category: app-audit-${{ matrix.app }}

      - name: Upload app audit results
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: app-audit-${{ matrix.app }}
          path: reports/app-audit/${{ matrix.app }}/
          retention-days: 30

      - name: Check audit thresholds
        run: |
          CRITICAL=$(jq -r '.summary.critical' reports/app-audit/${{ matrix.app }}/audit-results.json)
          HIGH=$(jq -r '.summary.high' reports/app-audit/${{ matrix.app }}/audit-results.json)

          echo "Critical: $CRITICAL, High: $HIGH"

          # Fail if critical or high issues found (gating control)
          if [[ $CRITICAL -gt 0 ]] || [[ $HIGH -gt 0 ]]; then
            echo "::error::App ${{ matrix.app }} has $CRITICAL critical and $HIGH high severity issues"
            exit 1
          fi

  aggregate-results:
    name: Aggregate Audit Results
    runs-on: ubuntu-latest
    needs: [infrastructure-audit, app-audit]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Download all artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          path: audit-results/

      - name: Run central audit aggregation
        run: bash scripts/ci/audit-central.sh all
        continue-on-error: true

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = JSON.parse(fs.readFileSync('docs/audit-trail/audit-summary.json', 'utf8'));

            const comment = `## üîç Security & Quality Audit Results

            | Category | Critical | High | Medium | Low | Pass |
            |----------|----------|------|--------|-----|------|
            | **Total** | ${summary.total.critical} | ${summary.total.high} | ${summary.total.medium} | ${summary.total.low} | ${summary.total.pass} |

            ${summary.total.critical > 0 || summary.total.high > 0 ? '‚ùå **FAILED**: Critical or High severity issues found' : '‚úÖ **PASSED**: No critical or high issues'}

            <details>
            <summary>View detailed breakdown</summary>

            ${summary.audits.map(a => `- **${a.name}**: ${a.critical}C / ${a.high}H / ${a.medium}M / ${a.low}L`).join('\n')}

            </details>

            See [full audit log](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Upload aggregated results
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: audit-summary
          path: docs/audit-trail/
          retention-days: 90

  production-readiness:
    name: Production Readiness Gate
    runs-on: ubuntu-latest
    needs: [aggregate-results]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Download audit summary
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: audit-summary
          path: audit-trail/

      - name: Check production readiness
        run: |
          CRITICAL=$(jq -r '.total.critical' audit-trail/audit-summary.json)
          HIGH=$(jq -r '.total.high' audit-trail/audit-summary.json)

          echo "Production Readiness Check:"
          echo "  Critical issues: $CRITICAL"
          echo "  High issues: $HIGH"

          if [[ $CRITICAL -gt 0 ]] || [[ $HIGH -gt 5 ]]; then
            echo "::error::PRODUCTION NOT READY: $CRITICAL critical, $HIGH high severity issues"
            echo "::error::Must resolve critical issues and reduce high issues to ‚â§5 before production deployment"
            exit 1
          else
            echo "‚úÖ PRODUCTION READY"
            exit 0
          fi
