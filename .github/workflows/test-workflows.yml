name: Test Workflows
on:
  push:
    paths:
      - '.github/workflows/**'
  pull_request:
    paths:
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  validate-syntax:
    name: Validate Workflow Syntax
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate YAML Syntax
        run: |
          echo "ðŸ” Validating workflow YAML syntax..."
          find .github/workflows -name "*.yml" -o -name "*.yaml" | while read -r file; do
            echo "Checking $file..."
            python3 -c "import yaml; yaml.safe_load(open('$file'))" || {
              echo "âŒ Invalid YAML in $file"
              exit 1
            }
          done
          echo "âœ… All workflow files have valid YAML syntax"

      - name: Check Required Permissions
        run: |
          echo "ðŸ” Checking permissions declarations..."
          missing_permissions=$(find .github/workflows -name "*.yml" -o -name "*.yaml" | xargs grep -L "permissions:")
          if [ -n "$missing_permissions" ]; then
            echo "âš ï¸  Workflows missing permissions declarations:"
            echo "$missing_permissions"
          else
            echo "âœ… All workflows have permissions declared"
          fi

      - name: Validate Timeouts
        run: |
          echo "â±ï¸  Checking timeout configurations..."
          find .github/workflows -name "*.yml" -o -name "*.yaml" | xargs grep -H "timeout-minutes:" | sort

      - name: Check for Hardcoded Secrets
        run: |
          echo "ðŸ”’ Checking for hardcoded secrets..."
          secret_patterns="SEMGREP_APP_TOKEN|GITHUB_TOKEN|AWS_ACCESS_KEY|SECRET_KEY"
          found_secrets=$(find .github/workflows -name "*.yml" -o -name "*.yaml" | xargs grep -l "$secret_patterns" 2>/dev/null || true)
          if [ -n "$found_secrets" ]; then
            echo "âš ï¸  Potential hardcoded secrets found in:"
            echo "$found_secrets"
            echo "Ensure these are using GitHub secrets syntax: \${{ secrets.SECRET_NAME }}"
          else
            echo "âœ… No hardcoded secrets detected"
          fi

  test-security:
    name: Security Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate Secret Usage
        run: |
          echo "ðŸ” Validating secret usage patterns..."
          # Check that secrets are used with proper syntax
          find .github/workflows -name "*.yml" -o -name "*.yaml" | xargs grep -n "secrets\." | head -10

      - name: Check Permission Boundaries
        run: |
          echo "ðŸ›¡ï¸  Analyzing permission scopes..."
          write_permissions=$(find .github/workflows -name "*.yml" -o -name "*.yaml" | xargs grep -A5 "permissions:" | grep "write" | wc -l)
          echo "Found $write_permissions write permissions across workflows"

      - name: Validate Action Versions
        run: |
          echo "ðŸ“¦ Checking action versions..."
          find .github/workflows -name "*.yml" -o -name "*.yaml" | xargs grep -o "uses: .*" | grep "@" | sort | uniq -c | sort -nr | head -10

  functional-test:
    name: Functional Testing
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test Workflow Dependencies
        run: |
          echo "ðŸ”— Testing workflow dependencies..."
          # Check for missing required workflows or actions
          echo "Checking for deprecated actions..."
          find .github/workflows -name "*.yml" -o -name "*.yaml" | xargs grep -n "uses:.*@v1\|uses:.*@v2" || echo "No deprecated v1/v2 actions found"

      - name: Validate Event Triggers
        run: |
          echo "ðŸŽ¯ Validating event trigger configurations..."
          find .github/workflows -name "*.yml" -o -name "*.yaml" | xargs grep -A10 "^on:" | grep -E "(push|pull_request|schedule|workflow_dispatch)" | sort | uniq -c

  report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: [validate-syntax, test-security]
    if: always()
    steps:
      - name: Generate Report
        run: |
          echo "## Workflow Validation Report" > report.md
          echo "" >> report.md
          echo "### Test Results:" >> report.md
          echo "- Syntax Validation: ${{ needs.validate-syntax.result }}" >> report.md
          echo "- Security Validation: ${{ needs.test-security.result }}" >> report.md
          echo "" >> report.md
          echo "### Summary:" >> report.md
          if [ "${{ needs.validate-syntax.result }}" = "success" ] && [ "${{ needs.test-security.result }}" = "success" ]; then
            echo "âœ… All workflow validations passed" >> report.md
          else
            echo "âŒ Some validations failed - review details above" >> report.md
          fi

      - name: Upload Test Report
        uses: actions/upload-artifact@v4
        with:
          name: workflow-test-report
          path: report.md
          retention-days: 30
