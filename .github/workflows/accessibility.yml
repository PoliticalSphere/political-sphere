name: Accessibility Testing
# Automated WCAG 2.2 AA compliance validation for all frontend applications
# Dependencies: axe-core, playwright
# Reference: docs/05-engineering-and-devops/ui/ux-accessibility.md

on:
  pull_request:
    branches: [main]
    paths:
      - 'apps/web/**'
      - 'apps/shell/**'
      - 'apps/feature-*/**'
      - 'libs/ui/**'
  workflow_dispatch:
    inputs:
      app:
        description: 'App to test (web, shell, feature-auth-remote, feature-dashboard-remote)'
        required: false
        default: 'web'

concurrency:
  group: accessibility-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  checks: write

env:
  NODE_VERSION: '22'

jobs:
  accessibility-scan:
    name: axe-core WCAG 2.2 AA Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    strategy:
      fail-fast: false
      matrix:
        app:
          - web
          - shell
          - feature-auth-remote
          - feature-dashboard-remote
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npx nx build ${{ matrix.app }} --skip-nx-cache
        env:
          NODE_ENV: production

      - name: Start application server
        run: |
          npx nx serve ${{ matrix.app }} --port=4200 &
          echo "SERVER_PID=$!" >> $GITHUB_ENV
          # Wait for server to be ready
          timeout 60 bash -c 'until curl -f http://localhost:4200 > /dev/null 2>&1; do sleep 2; done'
        env:
          CI: false

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run axe-core accessibility scan
        id: axe-scan
        run: |
          npx playwright test --config=playwright-a11y.config.ts --project=chromium
        continue-on-error: true

      - name: Upload accessibility report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-report-${{ matrix.app }}
          path: |
            playwright-report/
            test-results/
          retention-days: 30

      - name: Stop application server
        if: always()
        run: |
          if [ -n "$SERVER_PID" ]; then
            kill $SERVER_PID || true
          fi

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'test-results/accessibility-results.json';
            
            let comment = `## Accessibility Test Results - ${context.payload.pull_request.head.sha.substring(0, 7)}\n\n`;
            comment += `**App**: \`${{ matrix.app }}\`\n\n`;
            
            if (fs.existsSync(reportPath)) {
              const results = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              const violations = results.violations || [];
              
              if (violations.length === 0) {
                comment += '✅ **No accessibility violations found!**\n\n';
                comment += 'All WCAG 2.2 AA criteria passed.\n';
              } else {
                comment += `❌ **Found ${violations.length} accessibility violation(s)**\n\n`;
                comment += '| Severity | Rule | Impact | Nodes Affected |\n';
                comment += '|----------|------|--------|----------------|\n';
                
                violations.forEach(v => {
                  comment += `| ${v.impact} | ${v.id} | ${v.description} | ${v.nodes.length} |\n`;
                });
                
                comment += '\n**Action Required**: Fix all violations before merge.\n';
                comment += '\nSee [WCAG 2.2 Guidelines](https://www.w3.org/WAI/WCAG22/quickref/?versions=2.2&levels=aa)\n';
              }
            } else {
              comment += '⚠️ **Accessibility report not generated**\n\n';
              comment += 'Check workflow logs for errors.\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail job if violations found
        if: steps.axe-scan.outcome == 'failure'
        run: |
          echo "❌ Accessibility violations detected. See report for details."
          exit 1

  summary:
    name: Accessibility Summary
    runs-on: ubuntu-latest
    needs: accessibility-scan
    if: always()
    
    steps:
      - name: Check accessibility results
        run: |
          if [ "${{ needs.accessibility-scan.result }}" == "failure" ]; then
            echo "❌ One or more apps failed accessibility testing"
            echo "Review reports and fix WCAG 2.2 AA violations before merge"
            exit 1
          else
            echo "✅ All apps passed accessibility testing"
          fi
