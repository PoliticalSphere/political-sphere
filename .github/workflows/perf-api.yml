name: API Performance Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly performance tests
    - cron: '0 2 * * 1'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  performance-test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: perf
          POSTGRES_PASSWORD: perf
          POSTGRES_DB: perf
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Artillery
        run: npm install -g artillery

      - name: Wait for PostgreSQL
        run: |
          while ! pg_isready -h localhost -p 5432; do
            sleep 1
          done

      - name: Setup test database
        run: |
          npm run migrate
          # Seed performance test data
          PGPASSWORD=perf psql -h localhost -p 5432 -U perf -d perf -f scripts/seed/perf-seed.sql || true
        env:
          DATABASE_URL: postgresql://perf:perf@localhost:5432/perf

      - name: Start API service
        run: |
          npm run start:api &
          timeout 60 bash -c 'until curl -f http://localhost:4000/healthz; do sleep 1; done'
        env:
          NODE_ENV: production
          DATABASE_URL: postgresql://perf:perf@localhost:5432/perf

      - name: Run Artillery performance tests
        run: |
          artillery run scripts/performance/api-load-test.yml --output test-results/perf-report.json
        env:
          API_BASE_URL: http://localhost:4000

      - name: Generate performance report
        run: |
          artillery report test-results/perf-report.json --output test-results/perf-report.html

      - name: Upload performance results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: test-results/
          retention-days: 90

      - name: Performance regression check
        run: |
          # Compare against baseline
          if [ -f "scripts/performance-baseline.json" ]; then
            BASELINE_RESPONSE_TIME=$(jq '.thresholds.api.response_time_p95_max' scripts/performance-baseline.json)
            BASELINE_RPS=$(jq '.thresholds.api.requests_per_second_min' scripts/performance-baseline.json)
            BASELINE_ERROR_RATE=$(jq '.thresholds.api.error_rate_max' scripts/performance-baseline.json)

            CURRENT_RESPONSE_TIME=$(jq '.aggregate.summaries["http.response_time"].p95' test-results/perf-report.json)
            CURRENT_RPS=$(jq '.aggregate.rates["http.request_rate"]' test-results/perf-report.json)
            CURRENT_ERROR_RATE=$(jq -r '
              (.aggregate.counters["http.requests"] // 0) as $requests
              | if $requests == 0 then 0
                else (((.aggregate.counters["http.codes.4xx"] // 0) + (.aggregate.counters["http.codes.5xx"] // 0)) / $requests)
                end
            ' test-results/perf-report.json)

            if (( $(echo "$CURRENT_RESPONSE_TIME > $BASELINE_RESPONSE_TIME" | bc -l) )); then
              echo "‚ùå Performance regression: Response time ${CURRENT_RESPONSE_TIME}ms exceeds baseline ${BASELINE_RESPONSE_TIME}ms"
              exit 1
            fi

            if (( $(echo "$CURRENT_RPS < $BASELINE_RPS" | bc -l) )); then
              echo "‚ùå Performance regression: RPS ${CURRENT_RPS} below baseline ${BASELINE_RPS}"
              exit 1
            fi

            if (( $(echo "$CURRENT_ERROR_RATE > $BASELINE_ERROR_RATE" | bc -l) )); then
              echo "‚ùå Performance regression: Error rate ${CURRENT_ERROR_RATE} exceeds baseline ${BASELINE_ERROR_RATE}"
              exit 1
            fi

            echo "‚úÖ No performance regressions detected"
          else
            echo "‚ö†Ô∏è No performance baseline found, skipping regression check"
          fi

      - name: Comment PR with performance results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('test-results/perf-report.json', 'utf8'));

            const comment = `## üöÄ Performance Test Results

            **Response Time (95th percentile):** ${report.aggregate.summaries['http.response_time'].p95}ms
            **Requests per Second:** ${report.aggregate.rates['http.request_rate']}
            **Error Rate:** ${(report.aggregate.counters['http.codes.4xx'] + report.aggregate.counters['http.codes.5xx']) / report.aggregate.counters['http.requests'] * 100}%

            [View detailed report](${{github.server_url}}/${{github.repository}}/actions/runs/${{github.run_id}})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
