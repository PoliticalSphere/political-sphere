on:
  push:
    branches: [main, docs/observability-improvements]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Cancel in-progress runs for the same PR/branch
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write
  pull-requests: write
  checks: write

env:
  NODE_VERSION: '22'
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
jobs:
  # Quick validation - fail fast
  pre-flight:
    name: Pre-flight Checks
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate workflow files
        run: |
          echo "Validating GitHub Actions workflows..."
          find .github/workflows -name "*.yml" -o -name "*.yaml" | while read file; do
            echo "Checking $file"
            # Basic YAML validation
            python3 -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
          done

      - name: Check for secrets in code
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

  lint-and-typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    needs: [pre-flight]
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-node-deps
        with:
          node-version: ${{ env.NODE_VERSION }}

      - uses: ./.github/actions/quality-checks

      - name: Check for TODO/FIXME comments
        run: |
          echo "Checking for unresolved TODOs and FIXMEs..."
          grep -r "TODO\|FIXME" apps/ libs/ --exclude-dir=node_modules --exclude-dir=dist || echo "No TODOs found"

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [pre-flight]
    timeout-minutes: 15
    strategy:
      fail-fast: false # Prevent race conditions from failing entire matrix
      matrix:
        shard: [1, 2, 3]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-node-deps
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run tests (shard ${{ matrix.shard }}/3)
        run: npm run test -- --shard=${{ matrix.shard }}/3 --maxWorkers=2 --coverage --coverageDirectory=coverage-shard-${{ matrix.shard }}
      - name: Upload shard coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-shard-${{ matrix.shard }}
          path: coverage-shard-${{ matrix.shard }}/
          retention-days: 1

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-shard-${{ matrix.shard }}
          path: coverage/
          retention-days: 30

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage/lcov.info
          flags: unittests-shard-${{ matrix.shard }}
          name: codecov-shard-${{ matrix.shard }}
          fail_ci_if_error: false
  coverage-aggregation:
    name: Aggregate Test Coverage
    runs-on: ubuntu-latest
    needs: [test]
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Download all coverage shards
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-shard-*
          path: coverage-shards/

      - name: Combine coverage reports
        run: |
          npm install -g istanbul-combine
          find coverage-shards -name "lcov.info" -exec echo {} \; | xargs istanbul-combine --output combined-coverage.json --report json

      - name: Check combined coverage threshold
        run: |
          if [ -f combined-coverage.json ]; then
            COVERAGE=$(node -p "JSON.parse(require('fs').readFileSync('combined-coverage.json')).total.lines.pct || 0")
            echo "Combined Coverage: ${COVERAGE}%"
            if (( $(echo "$COVERAGE < 80" | bc -l) )); then
              echo "❌ Combined coverage ${COVERAGE}% is below 80% threshold"
              exit 1
            fi
            echo "✅ Combined coverage ${COVERAGE}% meets 80% threshold"
          else
            echo "⚠️ No combined coverage report found"
            exit 1
          fi

      - name: Upload combined coverage
        uses: actions/upload-artifact@v4
        with:
          name: combined-coverage
          path: combined-coverage.json
          retention-days: 30

  build:
    name: Build Applications
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, coverage-aggregation]
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-node-deps
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build all applications
        run: npm run build
      - name: Verify build outputs
        run: |
          echo "Checking build artifacts..."
          if [ ! -d "dist" ]; then
            echo "❌ dist/ directory not found"
            exit 1
          fi

          # Count built artifacts
          artifact_count=$(find dist -type f | wc -l)
          echo "✅ Found $artifact_count build artifacts"

          if [ $artifact_count -lt 5 ]; then
            echo "⚠️ Warning: Fewer artifacts than expected"
          fi

      - name: Generate build manifest
        run: |
          cat > dist/BUILD_MANIFEST.json <<EOF
          {
            "git_sha": "${{ github.sha }}",
            "git_ref": "${{ github.ref }}",
            "build_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "node_version": "${{ env.NODE_VERSION }}",
            "ci_run_id": "${{ github.run_id }}",
            "ci_run_number": "${{ github.run_number }}"
          }
          EOF
          echo "Build manifest:"
          cat dist/BUILD_MANIFEST.json

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/
          retention-days: 30

      - name: Upload build manifest
        uses: actions/upload-artifact@v4
        with:
          name: build-manifest
          path: dist/BUILD_MANIFEST.json
          retention-days: 90

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: [pre-flight]
    timeout-minutes: 15
    steps:
      - uses: ./.github/actions/setup-node-deps
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run npm audit
        run: |
          npm audit --audit-level=moderate || {
            echo "⚠️ npm audit found vulnerabilities"
            npm audit --audit-level=moderate --json > audit-results.json
            exit 1
          }

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        if: github.event_name == 'pull_request'
        with:
          fail-on-severity: moderate
          deny-licenses: GPL-2.0, GPL-3.0, AGPL-3.0

      - name: Run Semgrep Security Scan
        run: |
          echo "Running Semgrep security scan..."
          semgrep ci --config auto --json > semgrep-results.json || {
            echo "❌ Semgrep scan found issues"
            cat semgrep-results.json
            exit 1
          }
          echo "✅ Semgrep scan passed"
      - name: Upload security scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results
          path: |
            audit-results.json
            semgrep-results.json
          retention-days: 90

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [build]
    timeout-minutes: 20
    services:
      postgres:
        image: postgres:16-alpine
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-node-deps
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run database migrations
        run: npm run migrate
      - name: Verify database schema
        run: |
          echo "Verifying database schema after migrations..."
          # Check if migrations table exists and has entries
          MIGRATION_COUNT=$(psql postgresql://test:test@localhost:5432/testdb -t -c "SELECT COUNT(*) FROM _prisma_migrations;" 2>/dev/null || echo "0")
          if [ "$MIGRATION_COUNT" -eq "0" ]; then
            echo "❌ No migrations found in database"
            exit 1
          fi
          echo "✅ Found $MIGRATION_COUNT migration(s) applied"

      - name: Run integration tests
        run: npm run test:integration
      - name: Upload integration test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: test-results/
          retention-days: 30

  e2e-test:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: [build]
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-node-deps
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Prepare e2e environment
        run: npm run e2e:prepare
        timeout-minutes: 5

      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to be healthy..."
          timeout 60 bash -c 'until curl -f http://localhost:3000/health 2>/dev/null; do sleep 2; done' || {
            echo "❌ Services failed to start"
            docker compose logs
            exit 1
          }
          echo "✅ Services are ready"

      - name: Run e2e tests
        run: npm run test:e2e -- --reporter=html,json
      - name: Upload e2e test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: |
            playwright-report/
            test-results/
          retention-days: 30

      - name: Upload failure screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-failure-screenshots
          path: test-results/**/*.png
          retention-days: 7

      - name: Teardown e2e environment
        if: always()
        run: npm run docker:down

  accessibility-test:
    name: Accessibility Tests (WCAG 2.2 AA+)
    runs-on: ubuntu-latest
    needs: [build]
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-node-deps
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Start services for a11y testing
        run: npm run docker:up

      - name: Wait for services to be ready
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:3000/health 2>/dev/null; do sleep 2; done'

      - name: Run accessibility tests
        run: npm run test:a11y
      - name: Check for accessibility violations
        run: |
          if [ -f artifacts/accessibility-report.json ]; then
            violations=$(jq '.violations | length' artifacts/accessibility-report.json)
            if [ "$violations" -gt 0 ]; then
              echo "❌ Found $violations accessibility violations"
              jq '.violations' artifacts/accessibility-report.json
              exit 1
            fi
            echo "✅ No accessibility violations found"
          fi

      - name: Upload accessibility report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: accessibility-report
          path: artifacts/accessibility-report.json
          retention-days: 30

      - name: Comment PR with a11y results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('artifacts/accessibility-report.json')) {
              const report = JSON.parse(fs.readFileSync('artifacts/accessibility-report.json'));
              const violations = report.violations || [];
              const comment = violations.length === 0
                ? '✅ **Accessibility Check Passed** - No WCAG 2.2 AA+ violations found!'
                : `❌ **Accessibility Check Failed** - Found ${violations.length} violation(s):\n\n${violations.map(v => `- ${v.description}`).join('\n')}`;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      - name: Teardown services
        if: always()
        run: npm run docker:down

  performance-test:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    needs: [build]
    timeout-minutes: 15
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-node-deps
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run API performance tests
        run: npm run perf:api || echo "Performance tests not configured"
        continue-on-error: true

      - name: Compare with baseline
        run: |
          if [ -f scripts/perf/performance-baseline.json ] && [ -f artifacts/performance-results.json ]; then
            echo "Comparing performance with baseline..."
            # Add comparison logic here
            echo "✅ Performance comparison complete"
          else
            echo "⚠️ Baseline or results not found, skipping comparison"
          fi

      - name: Upload performance results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-results
          path: artifacts/performance-results.json
          retention-days: 30

  ci-performance-monitoring:
    name: CI Performance Monitoring
    runs-on: ubuntu-latest
    needs:
      [
        lint-and-typecheck,
        test,
        build,
        security-scan,
        integration-test,
        e2e-test,
        accessibility-test,
      ]
    if: always()
    timeout-minutes: 5
    steps:
      - name: Collect job metrics
        run: |
          echo "Collecting CI performance metrics..."
          cat > ci-metrics.json <<EOF
          {
            "run_id": "${{ github.run_id }}",
            "run_number": "${{ github.run_number }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "trigger": "${{ github.event_name }}",
            "ref": "${{ github.ref }}",
            "sha": "${{ github.sha }}",
            "jobs": {
              "lint-and-typecheck": {
                "result": "${{ needs.lint-and-typecheck.result }}",
                "duration_seconds": ${{ needs.lint-and-typecheck.outputs.duration || 0 }}
              },
              "test": {
                "result": "${{ needs.test.result }}",
                "duration_seconds": ${{ needs.test.outputs.duration || 0 }}
              },
              "coverage-aggregation": {
                "result": "${{ needs.coverage-aggregation.result }}",
                "duration_seconds": ${{ needs.coverage-aggregation.outputs.duration || 0 }}
              },
              "build": {
                "result": "${{ needs.build.result }}",
                "duration_seconds": ${{ needs.build.outputs.duration || 0 }}
              },
              "security-scan": {
                "result": "${{ needs.security-scan.result }}",
                "duration_seconds": ${{ needs.security-scan.outputs.duration || 0 }}
              },
              "integration-test": {
                "result": "${{ needs.integration-test.result }}",
                "duration_seconds": ${{ needs.integration-test.outputs.duration || 0 }}
              },
              "e2e-test": {
                "result": "${{ needs.e2e-test.result }}",
                "duration_seconds": ${{ needs.e2e-test.outputs.duration || 0 }}
              },
              "accessibility-test": {
                "result": "${{ needs.accessibility-test.result }}",
                "duration_seconds": ${{ needs.accessibility-test.outputs.duration || 0 }}
              }
            }
          }
          EOF

      - name: Upload CI metrics
        uses: actions/upload-artifact@v4
        with:
          name: ci-performance-metrics
          path: ci-metrics.json
          retention-days: 90

  # Final gate - all checks must pass
  all-checks-passed:
    name: All CI Checks Passed
    runs-on: ubuntu-latest
    needs:
      [
        lint-and-typecheck,
        test,
        build,
        security-scan,
        integration-test,
        e2e-test,
        accessibility-test,
        ci-performance-monitoring,
      ]
    if: always()
    steps:
      - name: Check if all jobs passed
        run: |
          if [[ "${{ needs.lint-and-typecheck.result }}" != "success" ]] || \
             [[ "${{ needs.test.result }}" != "success" ]] || \
             [[ "${{ needs.build.result }}" != "success" ]] || \
             [[ "${{ needs.security-scan.result }}" != "success" ]] || \
             [[ "${{ needs.integration-test.result }}" != "success" ]] || \
             [[ "${{ needs.e2e-test.result }}" != "success" ]] || \
             [[ "${{ needs.accessibility-test.result }}" != "success" ]]; then
            echo "❌ One or more CI checks failed"
            exit 1
          fi
          echo "✅ All CI checks passed successfully!"

      - name: Post success comment to PR
        if: github.event_name == 'pull_request' && success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ **All CI checks passed!** This PR is ready for review.'
            });
