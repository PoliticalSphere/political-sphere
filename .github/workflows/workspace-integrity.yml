name: Workspace Integrity Check

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  verify-workspace:
    name: Verify Workspace Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Critical Files Exist
        run: |
          echo "ğŸ” Verifying critical files..."

          required_files=(
            "package.json"
            "nx.json"
            "tsconfig.base.json"
            ".github/workflows/ci.yml"
            "README.md"
          )

          missing_files=()
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Missing: $file"
              missing_files+=("$file")
            else
              echo "âœ… Found: $file"
            fi
          done

          if [ ${#missing_files[@]} -ne 0 ]; then
            echo ""
            echo "âŒ ERROR: ${#missing_files[@]} critical file(s) missing!"
            exit 1
          fi

          echo ""
          echo "âœ… All critical files present"

      - name: Verify Source Code Presence
        run: |
          echo "ğŸ” Checking for source code files..."

          # Count TypeScript files (excluding node_modules, .nx, dist)
          ts_count=$(find . -name "*.ts" -o -name "*.tsx" | \
            grep -v node_modules | \
            grep -v ".nx/cache" | \
            grep -v "dist/" | \
            wc -l | tr -d ' ')

          # Count JavaScript files (excluding node_modules, .nx, dist, build artifacts)
          js_count=$(find . -name "*.js" -o -name "*.mjs" | \
            grep -v node_modules | \
            grep -v ".nx/cache" | \
            grep -v "dist/" | \
            grep -v "playwright-report" | \
            wc -l | tr -d ' ')

          echo "ğŸ“Š TypeScript files: $ts_count"
          echo "ğŸ“Š JavaScript files: $js_count"

          # Alert if counts are suspiciously low
          if [ "$ts_count" -lt 3 ]; then
            echo "âš ï¸  WARNING: Very few TypeScript files detected ($ts_count)"
          fi

          if [ "$js_count" -lt 10 ]; then
            echo "âš ï¸  WARNING: Very few JavaScript files detected ($js_count)"
          fi

          # Fail if BOTH are too low (likely means source is missing)
          if [ "$ts_count" -lt 3 ] && [ "$js_count" -lt 10 ]; then
            echo ""
            echo "âŒ ERROR: Workspace appears to be missing source code!"
            echo "This could indicate an incomplete commit or merge."
            exit 1
          fi

          echo ""
          echo "âœ… Source code files present"

      - name: Verify Apps Structure
        run: |
          echo "ğŸ” Checking apps directory structure..."

          if [ ! -d "apps" ]; then
            echo "âŒ ERROR: apps/ directory missing!"
            exit 1
          fi

          app_count=$(find apps -maxdepth 1 -mindepth 1 -type d | wc -l | tr -d ' ')
          echo "ğŸ“Š Found $app_count apps"

          # Check each app has either src/ or package.json or project.json
          for app_dir in apps/*/; do
            if [ -d "$app_dir" ]; then
              app_name=$(basename "$app_dir")
              has_src=false
              has_pkg=false
              has_proj=false
              
              [ -d "${app_dir}src" ] && has_src=true
              [ -f "${app_dir}package.json" ] && has_pkg=true
              [ -f "${app_dir}project.json" ] && has_proj=true
              
              if [ "$has_src" = true ] || [ "$has_pkg" = true ] || [ "$has_proj" = true ]; then
                echo "âœ… $app_name: OK"
              else
                echo "âš ï¸  $app_name: No src/, package.json, or project.json found"
              fi
            fi
          done

          echo ""
          echo "âœ… Apps structure verified"

      - name: Verify Libs Structure
        run: |
          echo "ğŸ” Checking libs directory structure..."

          if [ ! -d "libs" ]; then
            echo "âš ï¸  WARNING: libs/ directory missing (may be intentional)"
          else
            lib_count=$(find libs -maxdepth 1 -mindepth 1 -type d | wc -l | tr -d ' ')
            echo "ğŸ“Š Found $lib_count libraries"
            echo "âœ… Libs directory present"
          fi

      - name: Check GitHub Workflows
        run: |
          echo "ğŸ” Checking GitHub workflows..."

          if [ ! -d ".github/workflows" ]; then
            echo "âŒ ERROR: .github/workflows/ directory missing!"
            exit 1
          fi

          workflow_count=$(find .github/workflows -name "*.yml" -o -name "*.yaml" | wc -l | tr -d ' ')
          echo "ğŸ“Š Found $workflow_count workflow files"

          if [ "$workflow_count" -lt 1 ]; then
            echo "âŒ ERROR: No workflow files found!"
            exit 1
          fi

          echo "âœ… GitHub workflows present"

      - name: Generate Workspace Report
        if: always()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“‹ WORKSPACE INTEGRITY REPORT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š File Counts:"
          echo "   â€¢ Total files: $(git ls-files | wc -l)"
          echo "   â€¢ TypeScript: $(find . -name "*.ts" -o -name "*.tsx" | grep -v node_modules | grep -v .nx | wc -l)"
          echo "   â€¢ JavaScript: $(find . -name "*.js" -o -name "*.mjs" | grep -v node_modules | grep -v .nx | grep -v dist | wc -l)"
          echo "   â€¢ Markdown: $(find . -name "*.md" | grep -v node_modules | wc -l)"
          echo ""
          echo "ğŸ“ Directory Structure:"
          echo "   â€¢ Apps: $(find apps -maxdepth 1 -mindepth 1 -type d 2>/dev/null | wc -l)"
          echo "   â€¢ Libs: $(find libs -maxdepth 1 -mindepth 1 -type d 2>/dev/null | wc -l)"
          echo "   â€¢ Workflows: $(find .github/workflows -name "*.yml" -o -name "*.yaml" 2>/dev/null | wc -l)"
          echo ""
          echo "âœ… Workspace integrity check complete"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Fail Job on Error
        if: failure()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âŒ WORKSPACE INTEGRITY CHECK FAILED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Your workspace may be missing critical files."
          echo ""
          echo "Common causes:"
          echo "  â€¢ Incomplete merge or cherry-pick"
          echo "  â€¢ Partial commit (not all files added)"
          echo "  â€¢ .gitignore excluding too much"
          echo ""
          echo "To fix:"
          echo "  1. Check what files are in your working directory"
          echo "  2. Ensure all source files are staged: git status"
          echo "  3. Review recent commits for missing files"
          echo "  4. Compare with other branches if needed"
          echo ""
          exit 1
