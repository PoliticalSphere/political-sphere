# ============================================================================
# AI Maintenance Workflow
# ============================================================================
#
# Purpose: Nightly automated AI tooling execution and artifact generation
# Referenced in: tools/scripts/ai/README.md
# Status: OPERATIONAL
#
# ============================================================================

name: AI Maintenance

on:
  schedule:
    # Run nightly at 2 AM UTC (low-carbon period)
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      full_rebuild:
        description: 'Force full index rebuild (ignores incremental mode)'
        required: false
        type: boolean
        default: false
  push:
    branches: [main]
    paths:
      - 'tools/scripts/ai/**'
      - '.github/workflows/ai-maintenance.yml'

concurrency:
  group: ai-maintenance-${{ github.ref }}
  cancel-in-progress: false # Don't cancel nightly runs

jobs:
  build-ai-indices:
    name: Build AI Code Indices
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for change detection
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build AI system package
        run: |
          echo "Building @political-sphere/ai-system..."
          cd libs/ai-system
          npm run build
          cd ../..
      
      - name: Restore previous index cache
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: |
            ai-index/
            ai-cache/
          key: ai-index-${{ github.sha }}
          restore-keys: |
            ai-index-
      
      - name: Build code index
        run: |
          echo "Building AI code index..."
          if [[ "${{ inputs.full_rebuild }}" == "true" ]]; then
            echo "Full rebuild requested"
            node tools/scripts/ai/code-indexer.js build --full
          else
            echo "Incremental index update"
            node tools/scripts/ai/index-if-changed.js
          fi
      
      - name: Build context bundles
        run: |
          echo "Building AI context bundles..."
          node tools/scripts/ai/build-context-bundles.js
      
      - name: Preload context cache
        run: |
          echo "Preloading context cache..."
          node tools/scripts/ai/context-preloader.js preload
      
      - name: Pre-warm caches
        run: |
          echo "Pre-warming AI caches..."
          export PRE_CACHE_MAX_ENTRIES=2000
          node tools/scripts/ai/pre-cache.js
      
      - name: Update recent changes index
        run: |
          echo "Updating recent changes index..."
          node tools/scripts/ai/update-recent-changes.js
      
      - name: Save index cache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: |
            ai-index/
            ai-cache/
          key: ai-index-${{ github.sha }}
      
      - name: Upload AI indices as artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ai-indices-${{ github.run_number }}
          path: |
            ai-index/
            ai-cache/
            tools/ai/context-bundles/
          retention-days: 30
          compression-level: 9
      
      - name: Generate index report
        if: always()
        run: |
          echo "## AI Index Build Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** ${{ inputs.full_rebuild && 'Full Rebuild' || 'Incremental Update' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f ai-index/metadata.json ]; then
            echo "### Index Statistics" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat ai-index/metadata.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  competence-assessment:
    name: AI Competence Assessment
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 100 # Need history for quality assessment
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run competence monitor
        id: competence
        run: |
          echo "Running AI competence assessment..."
          node tools/scripts/ai/competence-monitor.js assess > competence-report.txt
          cat competence-report.txt
      
      - name: Upload competence metrics
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: competence-metrics-${{ github.run_number }}
          path: |
            ai-metrics/stats.json
            competence-report.txt
          retention-days: 90
      
      - name: Add competence summary
        if: always()
        run: |
          echo "## AI Competence Assessment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat competence-report.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  performance-monitoring:
    name: AI Performance Monitoring
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Collect performance metrics
        run: |
          echo "Collecting AI tool performance metrics..."
          node tools/scripts/ai/performance-monitor.js
      
      - name: Run analytics
        run: |
          echo "Generating AI usage analytics..."
          node tools/scripts/ai/analytics.js
      
      - name: Upload metrics
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ai-performance-metrics-${{ github.run_number }}
          path: ai-metrics/
          retention-days: 90

  smoke-test:
    name: AI Tools Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build-ai-indices]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Download AI indices
        uses: actions/download-artifact@v4
        with:
          name: ai-indices-${{ github.run_number }}
      
      - name: Run smoke test
        run: |
          echo "Running AI tools smoke test..."
          bash tools/scripts/ai/smoke.sh
      
      - name: Test suite validation
        run: |
          echo "Running AI tools test suite..."
          node tools/scripts/ai/test-ai-tools.cjs

  publish-indices:
    name: Publish AI Indices
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [smoke-test]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ai-index-cache # Dedicated branch for AI artifacts
          fetch-depth: 1
      
      - name: Download AI indices
        uses: actions/download-artifact@v4
        with:
          name: ai-indices-${{ github.run_number }}
      
      - name: Commit updated indices
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add ai-index/ ai-cache/ tools/ai/context-bundles/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore(ai): update AI indices and caches [skip ci]

            - Code index updated
            - Context bundles refreshed
            - Caches pre-warmed
            
            Generated by: ${{ github.workflow }}
            Run: ${{ github.run_number }}
            Commit: ${{ github.sha }}"
            
            git push origin ai-index-cache
          fi

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [build-ai-indices, competence-assessment, performance-monitoring, smoke-test]
    if: failure()
    
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸ¤– AI Maintenance Workflow Failed';
            const body = `## AI Maintenance Failure

            **Workflow:** ${{ github.workflow }}
            **Run:** ${{ github.run_number }}
            **Commit:** ${{ github.sha }}
            **Time:** ${new Date().toISOString()}

            ### Failed Jobs
            Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

            ### Action Required
            1. Review failed jobs in the workflow run
            2. Check AI tool logs and error messages
            3. Validate AI system dependencies
            4. Refer to troubleshooting guide: docs/05-engineering-and-devops/sops/ai-maintenance-sop.md

            ### Labels
            - \`ai-system\`
            - \`maintenance\`
            - \`automated-issue\`

            ---
            *This issue was automatically created by the AI Maintenance workflow.*`;

            // Check if similar issue already exists (open within last 24 hours)
            const existing = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ai-system,maintenance',
              per_page: 10
            });

            const recentIssue = existing.data.find(issue => {
              const createdAt = new Date(issue.created_at);
              const hoursSinceCreation = (Date.now() - createdAt) / (1000 * 60 * 60);
              return hoursSinceCreation < 24 && issue.title.includes('AI Maintenance');
            });

            if (recentIssue) {
              // Comment on existing issue instead of creating duplicate
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: recentIssue.number,
                body: `### Additional Failure\n\n${body}`
              });
              
              console.log(`Added comment to existing issue #${recentIssue.number}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['ai-system', 'maintenance', 'automated-issue']
              });
              
              console.log(`Created issue #${issue.data.number}`);
            }

# Workflow metadata for AI assistance
# AI-ASSISTABLE METADATA
# @workflow-purpose: Nightly AI tooling maintenance and index generation
# @workflow-triggers: [schedule:nightly, manual, push:ai-tools]
# @workflow-outputs: [ai-indices, competence-metrics, performance-data]
# @workflow-dependencies: [node:20, npm-packages]
# @workflow-risks: [HIGH:index-corruption, MEDIUM:cache-invalidation, LOW:metrics-drift]
# @workflow-sla: [p95-latency:<30min, availability:>98%, error-rate:<2%]
