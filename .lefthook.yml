# =============================================================================
# Lefthook Configuration - Git Hooks for Political Sphere
# Version: 2.0.0
# =============================================================================
#
# Pre-commit hooks with security checks, auto-fix, and quality validation
# Install: npm install -g lefthook && lefthook install
# Skip: LEFTHOOK=0 git commit (emergencies only)
#
# =============================================================================

min_version: 1.5.0

pre-commit:
  parallel: true

  commands:
    # Auto-fix code formatting
    prettier:
      glob: '*.{ts,tsx,js,jsx,json,css,scss,md,yml,yaml}'
      run: npx prettier --write {staged_files}
      stage_fixed: true

    eslint:
      glob: '*.{ts,tsx,js,jsx}'
      run: npx eslint --fix --max-warnings 0 {staged_files}
      stage_fixed: true

    # Security: Secret scanning
    gitleaks:
      run: |
        if command -v gitleaks >/dev/null 2>&1; then
          gitleaks protect --staged --verbose --redact
        else
          echo "⚠️  gitleaks not installed (brew install gitleaks)"
        fi

    # Security: Environment validation and secret detection
    env-validation:
      run: node tools/scripts/validation/validate-environment.mjs --mode=scan --files {staged_files}

    # Security: Check for hardcoded secrets (legacy fallback)
    detect-secrets:
      glob: '*.{ts,tsx,js,jsx,json,env,sh}'
      exclude: '*.test.{ts,tsx,js,jsx}|*.spec.{ts,tsx,js,jsx}|validate-environment.mjs'
      run: |
        # Exclude pattern definitions and validation scripts
        if grep -nE "(password|secret|key|token)\s*[:=]\s*['\"][^'\"]{20,}" {staged_files} 2>/dev/null | grep -v "pattern:" | grep -v "grep -nE"; then
          echo "❌ Potential hardcoded secrets detected!"
          exit 1
        fi

    # TypeScript validation
    type-check:
      glob: '*.{ts,tsx}'
      run: npx tsc --noEmit --skipLibCheck

    # No console.log in production (handled by ESLint with proper exclusions)
    # Disabled in favor of ESLint's no-console rule which supports overrides
    # no-console:
    #   skip: true

    # No .only() in tests
    no-only-tests:
      glob: '*.{test,spec}.{ts,tsx}'
      run: |
        if grep -nE "(describe|it|test)\\.only" {staged_files} 2>/dev/null; then
          echo "❌ .only() found in tests"
          exit 1
        fi

    # Validate JSON
    validate-json:
      glob: '*.json'
      run: |
        for file in {staged_files}; do
          jq empty "$file" 2>/dev/null || exit 1
        done

    # Validate YAML
    validate-yaml:
      glob: '*.{yml,yaml}'
      run: |
        if command -v yamllint >/dev/null 2>&1; then
          yamllint --strict {staged_files} 2>/dev/null || true
        fi

    # GitHub workflows
    actionlint:
      glob: '.github/workflows/*.{yml,yaml}'
      run: |
        if command -v actionlint >/dev/null 2>&1; then
          actionlint {staged_files}
        fi

    # Docker linting
    hadolint:
      glob: '**/Dockerfile*'
      run: |
        if command -v hadolint >/dev/null 2>&1; then
          hadolint {staged_files}
        fi

pre-push:
  commands:
    audit:
      run: npm run audit || true

    full-type-check:
      run: npx tsc --noEmit

    tests:
      run: npm test

commit-msg:
  commands:
    conventional:
      run: |
        msg=$(cat {1})
        if ! echo "$msg" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .{1,}"; then
          echo "❌ Use Conventional Commits: type(scope): message"
          exit 1
        fi
